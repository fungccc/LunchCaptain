<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>LunchCaptain V3.20 (Hybrid)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lz-string/1.4.4/lz-string.min.js"></script>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <style>
        body { font-family: "Microsoft JhengHei", -apple-system, BlinkMacSystemFont, sans-serif; background-color: #f0f2f5; }
        .btn { @apply font-bold py-3 px-4 rounded-lg transition duration-200 shadow-sm flex items-center justify-center text-sm; }
        .btn-primary { @apply bg-blue-600 text-white hover:bg-blue-700; }
        .btn-dark { @apply bg-slate-700 text-white hover:bg-slate-800; }
        .btn-success { @apply bg-green-600 text-white hover:bg-green-700; }
        .btn-action { @apply bg-indigo-600 text-white hover:bg-indigo-700; }
        .btn-warning { @apply bg-orange-500 text-white hover:bg-orange-600; }
        .btn-teal { @apply bg-teal-600 text-white hover:bg-teal-700; }
        .btn-outline { @apply border-2 border-gray-300 text-gray-600 hover:bg-gray-100; }
        .card { @apply bg-white rounded-xl shadow-sm border border-gray-200 p-5 mb-4; }
        .step-label { @apply text-sm font-bold text-gray-800 mb-1 flex items-center; }
        .step-num { @apply bg-blue-100 text-blue-800 text-xs font-bold px-2 py-0.5 rounded-full mr-2; }
        
        .option-tag { 
            border: 1px solid #d1d5db; background-color: white; color: #4b5563;
            border-radius: 0.5rem; padding: 0.5rem; font-size: 0.875rem; font-weight: bold;
            cursor: pointer; display: flex; align-items: center; justify-content: center;
            transition: all 0.2s; user-select: none;
        }
        .option-tag.active { 
            background-color: #2563eb !important; color: white !important;
            border-color: #2563eb !important; box-shadow: 0 2px 4px rgba(37, 99, 235, 0.3);
        }
        .check-icon { display: none; margin-right: 4px; font-size: 0.8em; }
        .option-tag.active .check-icon { display: inline-block; }
        
        .nav-btn { @apply flex flex-col items-center justify-center w-full h-full text-gray-400 hover:text-blue-600 active:scale-95 transition; }
        .nav-btn.active { @apply text-blue-600; }
        .nav-badge { @apply absolute top-2 right-1/4 bg-red-500 text-white text-[10px] min-w-[1.2rem] h-[1.2rem] flex items-center justify-center rounded-full hidden border-2 border-white; }
        
        .custom-select {
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");
            background-position: right 0.5rem center; background-repeat: no-repeat; background-size: 1.5em 1.5em; padding-right: 2.5rem; -webkit-appearance: none; appearance: none;
        }
        #orderQRCode { min-height: 180px; min-width: 180px; display: flex; align-items: center; justify-content: center; }
        
        /* Loading Mask */
        #wasm-loading { position: fixed; inset: 0; z-index: 100; display: flex; flex-direction: column; align-items: center; justify-content: center; background: rgba(255,255,255,0.98); backdrop-filter: blur(5px); transition: opacity 0.5s; }
        #wasm-loading.fade-out { opacity: 0; pointer-events: none; }
    </style>
</head>
<body class="pb-24 flex flex-col min-h-screen">

    <div id="wasm-loading">
        <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mb-4"></div>
        <h2 class="text-xl font-bold text-gray-800" id="loading-text">å•Ÿå‹•æ ¸å¿ƒå¼•æ“...</h2>
        <p class="text-xs text-gray-400 mt-2 font-mono" id="loading-sub">Mode: Auto Detect</p>
    </div>

    <header class="bg-slate-900 text-white p-4 shadow-md sticky top-0 z-50 flex justify-between items-center">
        <div class="flex items-center" onclick="confirmHome()">
            <div class="bg-blue-600 p-2 rounded-lg mr-3"><i class="fas fa-utensils text-white"></i></div>
            <div>
                <h1 class="text-lg font-bold tracking-wide leading-tight">LunchCaptain</h1>
                <p class="text-[10px] text-gray-400">åœ˜é•·æ•‘æ˜Ÿ v3.20 (Hybrid)</p>
            </div>
        </div>
        <div id="roleBadge" class="bg-yellow-400 text-black text-xs px-2 py-1 rounded font-bold hidden shadow"></div>
    </header>

    <div class="max-w-md mx-auto p-4 flex-grow w-full relative">
        <div id="setup-panel">
            <div class="flex justify-between items-center mb-4 px-1">
                <h2 class="text-lg font-bold text-gray-800">å»ºç«‹æ–°èœå–®</h2>
                <button onclick="window.toggleHistory()" class="text-blue-600 text-xs hover:underline"><i class="fas fa-history mr-1"></i>æ­·å²ç´€éŒ„</button>
            </div>

            <div id="historySection" class="hidden mb-4 bg-white p-3 rounded-lg border border-gray-200 shadow-sm">
                <label class="text-xs text-gray-500 mb-1 block">è¼‰å…¥èˆŠèœå–®ï¼š</label>
                <div class="flex gap-2">
                    <select id="historySelect" onchange="window.loadFromHistory(this.value)" class="flex-1 p-2 border rounded text-sm custom-select">
                        <option value="">-- è«‹é¸æ“‡ --</option>
                    </select>
                    <button onclick="window.clearHistory()" class="text-red-500 px-2 text-xs border border-red-200 rounded">æ¸…é™¤</button>
                </div>
            </div>

            <div class="card">
                <label class="step-label"><span class="step-num">1</span> èœå–®è¦ç¿»è­¯å—ï¼Ÿ</label>
                <select id="secondLang" class="w-full p-3 border rounded-lg text-sm custom-select bg-gray-50 focus:bg-white outline-none">
                    <option value="">ğŸš« ä¸éœ€ç¿»è­¯ (é è¨­)</option>
                    <option value="Traditional Chinese">1. ä¸­æ–‡ (ç¹é«”)</option>
                    <option value="English">2. è‹±æ–‡</option>
                    <option value="Japanese">3. æ—¥æ–‡</option>
                    <option value="Korean">4. éŸ“æ–‡</option>
                    <option value="Thai">5. æ³°æ–‡</option>
                </select>
            </div>

            <div class="card">
                <label class="step-label"><span class="step-num">2</span> é¸æ“‡ AI å¹«æ‰‹</label>
                <div class="grid grid-cols-2 gap-2">
                    <button onclick="window.setAI('gemini')" id="btn-gemini" class="btn btn-primary text-xs py-3 ring-2 ring-offset-1 ring-blue-600"><i class="fas fa-star mr-2"></i>Gemini</button>
                    <button onclick="window.setAI('chatgpt')" id="btn-chatgpt" class="btn btn-success text-xs py-3 opacity-60"><i class="fas fa-bolt mr-2"></i>ChatGPT</button>
                    <button onclick="window.setAI('grok')" id="btn-grok" class="btn btn-dark text-xs py-3 opacity-60"><i class="fas fa-rocket mr-2"></i>Grok</button>
                    <button onclick="window.setAI('copilot')" id="btn-copilot" class="btn btn-teal text-xs py-3 opacity-60"><i class="fab fa-microsoft mr-2"></i>Copilot</button>
                </div>
            </div>

            <div class="card border-l-4 border-l-indigo-500">
                <label class="step-label"><span class="step-num bg-indigo-100 text-indigo-800">3</span> å•Ÿå‹• AI åˆ†æ</label>
                <button onclick="window.copyPromptAndOpenAI()" class="w-full btn btn-action shadow-lg">
                    <i class="fas fa-external-link-alt mr-2"></i> è¤‡è£½æŒ‡ä»¤ â” è·³è½‰ AI ä¸Šå‚³ç…§ç‰‡
                </button>
            </div>

            <div class="card">
                <label class="step-label"><span class="step-num">4</span> è²¼ä¸Š AI å›å‚³è³‡æ–™</label>
                <div class="relative">
                    <textarea id="jsonInput" rows="3" class="w-full p-3 border-2 border-dashed border-gray-300 rounded-lg text-xs focus:border-blue-500 transition bg-gray-50" placeholder="åœ¨æ­¤é•·æŒ‰è²¼ä¸Š..."></textarea>
                    <button onclick="window.pasteFromClipboard()" class="absolute top-2 right-2 bg-white border border-gray-200 p-1 px-2 rounded text-gray-600 text-xs shadow-sm">
                        <i class="fas fa-paste mr-1"></i>è²¼ä¸Š
                    </button>
                </div>
            </div>
            
            <button onclick="window.parseMenuAndGenerateLink()" class="w-full btn btn-primary py-4 text-base shadow-lg mb-8">
                <i class="fas fa-qrcode mr-2"></i> 5. ç”Ÿæˆ QR CODE (é–‹å§‹é»é¤)
            </button>
        </div>

        <div id="share-panel" class="card hidden text-center pt-8 pb-8">
            <h2 class="text-xl font-bold mb-2 text-gray-800" id="shareTitle"></h2>
            <p class="text-sm text-gray-500 mb-6 bg-blue-50 inline-block px-3 py-1 rounded-full">ğŸ‘‡ è«‹åŒäº‹æƒææ­¤ QR CODE é»é¤ ğŸ‘‡</p>
            <div class="flex justify-center mb-6">
                <div id="menuQRCode" class="p-3 bg-white rounded-xl shadow-lg border border-gray-100"></div>
            </div>
            <button onclick="window.shareMenuWhatsapp()" class="btn btn-success w-full mb-3"><i class="fab fa-whatsapp mr-2"></i> æƒä¸åˆ°ï¼Ÿå‚³é€£çµçµ¦åŒäº‹</button>
            <button onclick="window.enterCaptainMode()" class="btn btn-warning w-full shadow-md text-base"><i class="fas fa-user-tie mr-2"></i> æˆ‘æ˜¯åœ˜é•·ï¼Œé€²å…¥æ”¶å–®æ¨¡å¼</button>
        </div>

        <div id="order-panel" class="hidden">
            <div class="mb-4 sticky top-16 z-30 bg-[#f0f2f5] pb-2 pt-1 shadow-sm">
                <h2 id="storeName" class="text-2xl font-bold text-gray-800 text-center mb-2"></h2>
                <div id="guestInfoDisplay" class="hidden text-center text-sm text-gray-600 mb-2 bg-white p-2 rounded-lg shadow-sm mx-4 border border-gray-100">
                    <div class="flex justify-center items-center gap-3">
                        <span class="font-bold text-gray-800"><i class="fas fa-user text-blue-500 mr-1"></i><span id="displayRoleName"></span></span> 
                        <span class="text-gray-500"><i class="fas fa-phone text-green-500 mr-1"></i><span id="displayRolePhone"></span></span>
                        <button onclick="window.resetGuestInfo()" class="text-xs text-gray-400 underline hover:text-blue-600 ml-2">ä¿®æ”¹</button>
                    </div>
                </div>
            </div>
            <div id="menuContainer" class="mb-24 pb-10"></div>
        </div>

        <div id="note-modal" class="fixed inset-0 bg-black bg-opacity-60 z-[70] hidden flex items-end justify-center sm:items-center sm:px-4">
            <div class="bg-white w-full sm:max-w-sm sm:rounded-xl rounded-t-2xl shadow-2xl overflow-hidden flex flex-col max-h-[85vh]">
                <div class="p-4 border-b bg-gray-50 flex justify-between items-start">
                    <div><h3 class="font-bold text-lg text-gray-800" id="note-item-name"></h3><p class="text-sm text-gray-500" id="note-item-trans"></p></div>
                    <p class="text-blue-600 font-bold text-lg" id="note-item-price"></p>
                </div>
                <div class="p-5 overflow-y-auto">
                    <p class="text-xs font-bold text-gray-500 mb-3 uppercase tracking-wider">å®¢è£½åŒ–é¸é … (å¯å¤šé¸)</p>
                    <div class="grid grid-cols-3 gap-2 mb-4" id="opt-container"></div>
                    <div class="mt-4 flex gap-2 items-center">
                        <div class="option-tag whitespace-nowrap" id="btn-other" onclick="window.toggleOther(this)"><i class="fas fa-check check-icon"></i><span>å…¶ä»–</span></div>
                        <input type="text" id="note-other-input" class="w-full p-3 border rounded-lg text-sm bg-gray-50 focus:ring-2 focus:ring-blue-200 outline-none transition disabled:opacity-50" placeholder="å‚™è¨»å…§å®¹..." disabled>
                    </div>
                </div>
                <div class="p-4 border-t bg-white flex gap-3">
                    <button onclick="window.closeNoteModal()" class="flex-1 btn btn-outline">å–æ¶ˆ</button>
                    <button onclick="window.confirmAddItem()" class="flex-1 btn btn-primary">åŠ å…¥è¨‚å–®</button>
                </div>
            </div>
        </div>

        <div id="cart-modal" class="fixed inset-0 bg-black bg-opacity-90 z-[80] hidden flex flex-col items-center justify-center p-4">
            <div class="bg-white rounded-xl p-5 w-full max-w-sm mb-4 relative shadow-2xl flex flex-col max-h-[85vh]">
                <div class="text-center border-b pb-3 mb-3"><h3 class="font-bold text-xl text-gray-800">ğŸ›’ è³¼ç‰©è»Šç¢ºèª</h3></div>
                <div id="cart-list" class="flex-grow overflow-y-auto mb-4 space-y-2 px-1"></div>
                <div class="flex justify-between font-bold text-xl border-t pt-3 mb-3"><span>ç¸½è¨ˆ</span><span id="cart-total-price" class="text-red-600">$0</span></div>
                <div id="cart-action-hint" class="text-xs text-center text-gray-500 font-bold bg-gray-100 py-2 rounded mb-3 border border-gray-200"></div>
                <div class="grid grid-cols-2 gap-3 w-full">
                    <button onclick="window.closeCartModal()" class="btn btn-outline text-sm"><i class="fas fa-arrow-left mr-2"></i>ç¹¼çºŒé»</button>
                    <button id="btn-final-submit" onclick="window.finalSubmit()" class="btn text-sm text-lg shadow-lg animate-pulse text-white bg-blue-600">ç¢ºèª</button>
                </div>
            </div>
        </div>

        <div id="ticket-modal" class="fixed inset-0 bg-black bg-opacity-95 z-[90] hidden flex flex-col items-center justify-center p-4 overflow-y-auto">
            <div class="bg-white rounded-xl p-6 w-full max-w-sm mb-4 shadow-2xl">
                <div class="text-center border-b-2 border-dashed border-gray-200 pb-4 mb-4"><h3 class="font-bold text-xl text-gray-800" id="ticket-store"></h3><p class="text-[10px] text-gray-400 mt-1 uppercase tracking-[0.2em]">ORDER TICKET</p></div>
                <div class="flex justify-between text-base mb-4 bg-blue-50 p-3 rounded-lg border border-blue-100">
                    <span class="font-bold text-gray-700"><i class="fas fa-user mr-2 text-blue-500"></i><span id="ticket-name"></span></span>
                    <span class="font-bold text-gray-700"><i class="fas fa-phone mr-2 text-green-500"></i><span id="ticket-phone"></span></span>
                </div>
                <div id="ticket-items" class="text-sm space-y-2 mb-4 max-h-40 overflow-y-auto"></div>
                <div class="flex justify-between font-bold text-xl border-t-2 border-gray-800 pt-4 mb-4"><span>ç¸½è¨ˆ</span><span id="ticket-total" class="text-red-600"></span></div>
                <div class="flex flex-col items-center justify-center mb-2">
                    <div id="orderQRCode" class="p-2 bg-white rounded border border-gray-200 mb-2"></div>
                    <p class="text-xs text-center text-gray-400">è«‹æˆªåœ–ä¿å­˜ï¼Œæˆ–ç›´æ¥è®“åœ˜é•·æƒæ</p>
                </div>
                <div class="bg-gray-50 p-3 rounded border border-gray-200 mt-2">
                    <p class="text-[10px] text-gray-500 mb-1">è‹¥ QR CODE ç„¡æ³•é¡¯ç¤ºï¼Œè«‹è¤‡è£½ä»£ç¢¼ï¼š</p>
                    <textarea id="ticket-raw-code" class="w-full h-12 text-[10px] p-1 border rounded resize-none bg-white text-gray-600 break-all" readonly></textarea>
                    <button onclick="window.copyTicketCode()" class="w-full bg-gray-200 hover:bg-gray-300 text-gray-700 text-xs py-1 rounded mt-1"><i class="fas fa-copy mr-1"></i>è¤‡è£½ä»£ç¢¼</button>
                </div>
            </div>
            <div class="grid grid-cols-2 gap-3 w-full max-w-sm mb-3">
                <button onclick="window.downloadTicket()" class="btn btn-dark text-sm"><i class="fas fa-download mr-2"></i>ä¸‹è¼‰åœ–ç‰‡</button>
                <button onclick="window.sendToWhatsapp()" class="btn btn-success text-sm"><i class="fab fa-whatsapp mr-2"></i>å‚³çµ¦åœ˜é•·</button>
            </div>
            <button onclick="document.getElementById('ticket-modal').classList.add('hidden')" class="text-white underline text-sm mt-2 mb-10">é—œé–‰</button>
        </div>

        <div id="scanner-modal" class="fixed inset-0 bg-black z-[90] hidden flex flex-col">
            <div class="flex justify-between items-center p-4 bg-black/50 text-white backdrop-blur-sm absolute top-0 w-full z-10">
                <h3 class="font-bold text-lg"><i class="fas fa-camera mr-2"></i>æƒæè¨‚å–®</h3>
                <button onclick="window.stopScanner()" class="text-2xl opacity-80 hover:opacity-100"><i class="fas fa-times"></i></button>
            </div>
            <div class="flex-grow flex flex-col justify-center bg-black relative">
                <div id="reader" class="w-full h-64 bg-black border-y-2 border-blue-500"></div>
                <div class="absolute bottom-0 w-full bg-gray-900 p-6 rounded-t-3xl border-t border-gray-700">
                    <div class="flex gap-2">
                        <input type="text" id="manualOrderInput" class="flex-1 bg-gray-800 text-white border border-gray-700 rounded-lg p-3 text-sm focus:border-blue-500 focus:outline-none" placeholder="è²¼ä¸Šä»£ç¢¼...">
                        <button onclick="window.manualImportOrder()" class="btn btn-action whitespace-nowrap px-6">åŒ¯å…¥</button>
                    </div>
                </div>
            </div>
        </div>

        <div id="summary-panel" class="fixed inset-0 bg-gray-100 z-[70] hidden flex flex-col">
            <div class="bg-white p-4 shadow-md flex justify-between items-center sticky top-0 z-10">
                <h2 class="text-xl font-bold text-gray-800"><i class="fas fa-clipboard-list mr-2 text-blue-600"></i>è¨‚å–®ç¸½çµ</h2>
                <button onclick="document.getElementById('summary-panel').classList.add('hidden')" class="text-gray-400 hover:text-gray-600"><i class="fas fa-times text-xl"></i></button>
            </div>
            <div id="summary-content" class="flex-grow overflow-y-auto p-4 space-y-3 pb-40"></div>
            <div class="bg-white p-4 shadow-inner sticky bottom-0 z-10">
                <div class="flex justify-between text-xl font-bold mb-3 border-b pb-2"><span>ç¸½é‡‘é¡</span><span id="grand-total" class="text-red-600">$0</span></div>
                <div class="grid grid-cols-2 gap-2 mb-2">
                    <button onclick="window.copyForRestaurant()" class="btn btn-success text-xs"><i class="fab fa-whatsapp mr-1 text-base"></i> çµ¦é¤å»³</button>
                    <button onclick="window.shareSystem()" class="btn btn-dark text-xs"><i class="fas fa-share-alt mr-1 text-base"></i> åˆ†äº«</button>
                </div>
                <button onclick="window.copyForGroup()" class="w-full btn btn-action text-xs mb-2"><i class="fas fa-users mr-1 text-base"></i> è¤‡è£½æ¸…å–® (Line)</button>
            </div>
        </div>
    </div>

    <nav id="bottom-nav" class="fixed bottom-0 w-full bg-white shadow-[0_-2px_15px_rgba(0,0,0,0.05)] flex justify-around items-center h-[4.5rem] z-50 border-t border-gray-100 pb-safe">
        <button id="nav-checkout" onclick="window.checkOut()" class="nav-btn w-1/3 hidden relative group">
            <div class="relative"><i class="fas fa-shopping-cart text-xl mb-1 group-active:scale-90 transition"></i><span id="cartCount" class="nav-badge">0</span></div>
            <span class="text-[10px]">é»å¥½äº†</span>
        </button>
        <button id="nav-scan" onclick="window.startScanner()" class="nav-btn w-1/3 hidden group"><i class="fas fa-camera text-xl mb-1 group-active:scale-90 transition"></i><span class="text-[10px]">æƒææ”¶å–®</span></button>
        <button id="nav-bill" onclick="window.showSummary()" class="nav-btn w-1/3 hidden group relative">
            <div class="relative"><i class="fas fa-list-alt text-xl mb-1 group-active:scale-90 transition"></i><span id="orderCountBadge" class="nav-badge bg-blue-600">0</span></div>
            <span class="text-[10px]">è¨‚å–®ç¸½çµ</span>
        </button>
    </nav>

    <script type="module">
        // æ”¹ç”¨ esm.sh CDNï¼Œå®ƒå° Module çš„å°è£æ¯” unpkg æ›´ç©©å®š
        import init, { compress, decompress } from 'https://esm.sh/brotli-wasm@3.0.1';

        let compressionMode = 'LZSTRING'; // é è¨­é™ç´šæ¨¡å¼ï¼Œç›´åˆ° WASM æˆåŠŸ
        let isReady = false;

        async function initHybridSystem() {
            try {
                // è‡ªå‹•åˆ¤æ–· init æ˜¯ Promise é‚„æ˜¯ Function (è§£æ±º Image 1 çš„å ±éŒ¯)
                if (typeof init === 'function') {
                    await init(); 
                } else {
                    await init; // ç•¶ init å·²ç¶“æ˜¯ Instance æ™‚ç›´æ¥ await
                }

                // æ¸¬è©¦åŠŸèƒ½æ˜¯å¦æ­£å¸¸
                const test = compress(new TextEncoder().encode("ok"));
                if(test.length > 0) {
                    compressionMode = 'BROTLI';
                    document.getElementById('loading-text').innerText = "Brotli æ ¸å¿ƒå°±ç·’";
                    document.getElementById('loading-sub').innerText = "High Compression Mode";
                }
            } catch (e) {
                console.warn("WASM Init Failed, Fallback to LZString", e);
                document.getElementById('loading-text').innerText = "ä½¿ç”¨ç›¸å®¹æ¨¡å¼";
                document.getElementById('loading-sub').innerText = "LZString Mode Active";
            } finally {
                // éš±è— Loading ç•«é¢
                setTimeout(() => {
                    document.getElementById('wasm-loading').classList.add('fade-out');
                    isReady = true;
                }, 500);

                // æª¢æŸ¥ç¶²å€åƒæ•¸
                const params = new URLSearchParams(window.location.search);
                const compressedMenu = params.get('menu');
                if (compressedMenu) window.initGuestMode(compressedMenu);
                else window.initCaptainMode();
            }
        }

        // ============================================
        // 2. è¼”åŠ©å·¥å…·: Base64 <-> Uint8Array
        // ============================================
        function uint8ArrayToBase64(bytes) {
            let binary = '';
            const len = bytes.byteLength;
            for (let i = 0; i < len; i++) binary += String.fromCharCode(bytes[i]);
            return window.btoa(binary).replace(/\+/g, '-').replace(/\//g, '_').replace(/=+$/, '');
        }

        function base64ToUint8Array(base64) {
            let str = base64.replace(/-/g, '+').replace(/_/g, '/');
            while (str.length % 4) str += '=';
            const binary_string = window.atob(str);
            const len = binary_string.length;
            const bytes = new Uint8Array(len);
            for (let i = 0; i < len; i++) bytes[i] = binary_string.charCodeAt(i);
            return bytes;
        }

        // ============================================
        // 3. æ··åˆå£“ç¸®/è§£å£“ç¸® å°è£ (Hybrid Wrapper)
        // ============================================
        window.generateLinkAndShow = function() {
            if (!isReady) return Swal.fire("è«‹ç¨å€™", "æ ¸å¿ƒåˆå§‹åŒ–ä¸­...", "info");
            
            try {
                let compressedString = "";
                
                if (compressionMode === 'BROTLI') {
                    // Brotli æ¨¡å¼
                    const jsonStr = JSON.stringify(menuData);
                    const inputBytes = new TextEncoder().encode(jsonStr);
                    const compressedBytes = compress(inputBytes);
                    // å‰ç¶´ 'B' ä»£è¡¨ Brotliï¼Œæ–¹ä¾¿æœªä¾†è­˜åˆ¥
                    compressedString = 'B' + uint8ArrayToBase64(compressedBytes);
                } else {
                    // LZString æ¨¡å¼ (å‚™æ¡ˆ)
                    compressedString = LZString.compressToEncodedURIComponent(JSON.stringify(menuData));
                }

                const shareUrl = `${window.location.origin}${window.location.pathname}?menu=${compressedString}`;
                document.getElementById('shareTitle').textContent = menuData.r;
                const qr = document.getElementById('menuQRCode'); qr.innerHTML = "";
                new QRCode(qr, { text: shareUrl, width: 220, height: 220, correctLevel: QRCode.CorrectLevel.L });
                document.getElementById('setup-panel').classList.add('hidden');
                document.getElementById('share-panel').classList.remove('hidden');
            } catch (e) {
                Swal.fire('å£“ç¸®å¤±æ•—', e.message, 'error');
            }
        };

        window.shareMenuWhatsapp = function() {
            if (!isReady) return;
            let compressedString = "";
            if (compressionMode === 'BROTLI') {
                const jsonStr = JSON.stringify(menuData);
                compressedString = 'B' + uint8ArrayToBase64(compress(new TextEncoder().encode(jsonStr)));
            } else {
                compressedString = LZString.compressToEncodedURIComponent(JSON.stringify(menuData));
            }
            const shareUrl = `${window.location.origin}${window.location.pathname}?menu=${compressedString}`;
            window.location.href = `whatsapp://send?text=${encodeURIComponent("ä¾†é»é¤å§ï¼" + shareUrl)}`;
        };

        window.initGuestMode = function(compressed) {
            if (!isReady) { setTimeout(()=>window.initGuestMode(compressed), 200); return; } // ç­‰å¾…åˆå§‹åŒ–
            
            try {
                // è‡ªå‹•åµæ¸¬æ ¼å¼
                if (compressed.startsWith('B')) {
                    // Brotli æ ¼å¼ (ç§»é™¤å‰ç¶´ 'B')
                    const realCompressed = compressed.substring(1);
                    const compressedBytes = base64ToUint8Array(realCompressed);
                    const decompressedBytes = decompress(compressedBytes);
                    const jsonStr = new TextDecoder().decode(decompressedBytes);
                    menuData = JSON.parse(jsonStr);
                } else {
                    // LZString æ ¼å¼ (èˆŠç‰ˆæˆ– fallback)
                    // å˜—è©¦ Brotli è§£å£“å¤±æ•—æœƒæ‹‹éŒ¯ï¼Œæˆ‘å€‘æ•æ‰å¾Œå˜—è©¦ LZString
                    try {
                        // æœ‰äº›èˆŠé€£çµå¯èƒ½æ²’æœ‰å‰ç¶´ï¼Œå…ˆè©¦ LZString
                        menuData = JSON.parse(LZString.decompressFromEncodedURIComponent(compressed));
                        if(!menuData) throw new Error();
                    } catch(err) {
                        // å¦‚æœ LZString ä¹Ÿä¸è¡Œï¼Œå¯èƒ½æ˜¯è£¸ Brotli (èˆŠç‰ˆ)
                        const cb = base64ToUint8Array(compressed);
                        const db = decompress(cb);
                        menuData = JSON.parse(new TextDecoder().decode(db));
                    }
                }

                if (!menuData) throw new Error("è³‡æ–™ç‚ºç©º");

                isCaptainMode = false;
                document.getElementById('roleBadge').textContent = "é»é¤æ¨¡å¼";
                document.getElementById('roleBadge').classList.remove('hidden');
                document.getElementById('setup-panel').classList.add('hidden');
                document.getElementById('order-panel').classList.remove('hidden');
                document.getElementById('nav-checkout').classList.remove('hidden');
                document.getElementById('nav-checkout').classList.add('w-full');
                const savedUser = localStorage.getItem('lunch_captain_user');
                if(savedUser) { userInfo = JSON.parse(savedUser); window.updateUserDisplay(); }
                window.renderMenu();
            } catch (e) { 
                console.error(e);
                Swal.fire('é€£çµç„¡æ•ˆ', 'ç„¡æ³•è§£æè³‡æ–™ï¼Œè«‹ç¢ºèªç¶²å€å®Œæ•´', 'error'); 
            }
        };

        // ============================================
        // 4. æ‡‰ç”¨ç¨‹å¼è®Šæ•¸èˆ‡é‚è¼¯
        // ============================================
        let currentAI = 'gemini';
        let menuData = null;
        let myCart = []; 
        let allOrders = {}; 
        let html5QrcodeScanner = null;
        let tempItem = null; 
        let userInfo = { name: '', phone: '' };
        let isCaptainMode = false;
        
        const optMap = { "å°‘è¾£":"a", "ä¸­è¾£":"b", "å¤§è¾£":"c", "èµ°å†°":"d", "å°‘å†°":"e", "å¤šå†°":"f", "èµ°ç”œ":"g", "å°‘ç”œ":"h", "åŠç³–":"i", "èµ°å¥¶":"j", "èµ°è”¥":"k", "èµ°èŠ«è½":"l" };
        const revOptMap = Object.fromEntries(Object.entries(optMap).map(a => a.reverse()));

        // Expose functions to window
        window.confirmHome = function() { if(myCart.length > 0 && !confirm("è³¼ç‰©è»Šé‚„æœ‰é¤é»ï¼Œç¢ºå®šè¦å›åˆ°é¦–é å—ï¼Ÿ")) return; location.href = location.pathname.split('#')[0]; };
        
        window.initCaptainMode = function() {
            document.getElementById('setup-panel').classList.remove('hidden');
            window.loadHistoryDropdown();
            window.setAI('gemini');
        };

        window.toggleHistory = function() { document.getElementById('historySection').classList.toggle('hidden'); };

        window.setAI = function(ai) {
            currentAI = ai;
            ['gemini','chatgpt','grok','copilot'].forEach(k => { const btn = document.getElementById(`btn-${k}`); if(btn) { btn.classList.remove('ring-2', 'ring-offset-1', 'ring-blue-600', 'opacity-100'); btn.classList.add('opacity-60'); } });
            const activeBtn = document.getElementById(`btn-${currentAI}`);
            if(activeBtn) { activeBtn.classList.remove('opacity-60'); activeBtn.classList.add('ring-2', 'ring-offset-1', 'ring-blue-600', 'opacity-100'); }
        };

        window.copyPromptAndOpenAI = function() {
            const returnUrl = window.location.href.split('#')[0].split('?')[0] + "#import_menu";
            const targetLang = document.getElementById('secondLang').value;
            let trans = `field "n" MUST be the ORIGINAL language in image.`;
            let fields = `"n":"Original Name", "p":Price_Number`;
            if (targetLang) { trans += ` Also add "t" (translation to ${targetLang}).`; fields += `, "t":"Translated Name"`; }
            let prompt = `Role: Menu Data Analyst. Output: Strict JSON ONLY. Structure: {"r":"Restaurant","m":[{"c":"Category","i":[{${fields}}]}]} Rules: 1. ${trans} 2. "p" is number. 3. Sizes=separate items. 4. Append link: [â†©ï¸ Click here to Import Menu](${returnUrl})`;
            if(currentAI === 'grok') prompt += `\n\n(Grok users: switch to browser)`;
            navigator.clipboard.writeText(prompt).then(() => {
                let url = "https://gemini.google.com/";
                if(currentAI === 'chatgpt') url = "https://chat.openai.com/";
                if(currentAI === 'grok') url = "https://x.com/i/grok";
                if(currentAI === 'copilot') url = "https://copilot.microsoft.com/";
                window.open(url, '_blank');
            });
        };

        window.pasteFromClipboard = async function() { try { document.getElementById('jsonInput').value = await navigator.clipboard.readText(); } catch (e) { Swal.fire('æç¤º', 'è«‹æ‰‹å‹•è²¼ä¸Š', 'info'); } };

        window.parseMenuAndGenerateLink = function() {
            const raw = document.getElementById('jsonInput').value;
            if(!raw) return Swal.fire('éŒ¯èª¤', 'è«‹è²¼ä¸Š JSON', 'error');
            try {
                const jsonMatch = raw.match(/\{[\s\S]*\}/);
                if (!jsonMatch) throw new Error("ç„¡æ•ˆ JSON");
                menuData = JSON.parse(jsonMatch[0]);
                if (!menuData.m) throw new Error("æ ¼å¼éŒ¯èª¤");
                let gId = 0;
                menuData.m.forEach(c => c.i.forEach(i => i._id = (gId++).toString(36))); 
                window.saveToHistory(menuData);
                window.generateLinkAndShow();
            } catch (e) { Swal.fire('è§£æå¤±æ•—', e.message, 'error'); }
        };

        window.saveToHistory = function(data) {
            let history = JSON.parse(localStorage.getItem('lunch_captain_history') || "[]");
            history = history.filter(h => h.name !== data.r);
            history.unshift({ name: data.r, data: data, time: Date.now() });
            localStorage.setItem('lunch_captain_history', JSON.stringify(history));
            window.loadHistoryDropdown();
        };

        window.loadHistoryDropdown = function() {
            const h = JSON.parse(localStorage.getItem('lunch_captain_history') || "[]");
            const s = document.getElementById('historySelect');
            if(h.length > 0) {
                document.getElementById('historySection').classList.remove('hidden');
                s.innerHTML = '<option value="">-- è«‹é¸æ“‡ --</option>';
                h.forEach((item, i) => s.innerHTML += `<option value="${i}">${item.name}</option>`);
            }
        };

        window.loadFromHistory = function(idx) {
            if(idx === "") return;
            menuData = JSON.parse(localStorage.getItem('lunch_captain_history'))[idx].data;
            let gId = 0;
            menuData.m.forEach(c => c.i.forEach(i => { if(!i._id) i._id = (gId++).toString(36); else gId++; }));
            window.generateLinkAndShow();
        };

        window.clearHistory = function() { if(confirm('æ¸…é™¤ç´€éŒ„ï¼Ÿ')) { localStorage.removeItem('lunch_captain_history'); location.reload(); } };

        window.enterCaptainMode = function() {
            isCaptainMode = true;
            document.getElementById('roleBadge').textContent = "åœ˜é•·æ¨¡å¼";
            document.getElementById('roleBadge').classList.remove('hidden');
            document.getElementById('share-panel').classList.add('hidden');
            document.getElementById('order-panel').classList.remove('hidden');
            document.getElementById('nav-checkout').classList.remove('hidden');
            document.getElementById('nav-checkout').classList.add('w-1/3');
            document.getElementById('nav-scan').classList.remove('hidden');
            document.getElementById('nav-scan').classList.add('w-1/3');
            document.getElementById('nav-bill').classList.remove('hidden');
            document.getElementById('nav-bill').classList.add('w-1/3');
            userInfo = { name: "åœ˜é•·", phone: "000" };
            window.updateUserDisplay();
            window.renderMenu();
        };

        window.renderMenu = function() {
            document.getElementById('storeName').textContent = menuData.r || "é¤å»³";
            const c = document.getElementById('menuContainer'); c.innerHTML = "";
            menuData.m.forEach(cat => {
                const s = document.createElement('div'); s.className = "mb-6";
                s.innerHTML = `<h3 class="font-bold text-gray-800 border-l-4 border-blue-600 pl-3 mb-3 sticky top-[4.5rem] bg-[#f0f2f5] z-20 py-2">${cat.c}</h3>`;
                const g = document.createElement('div'); g.className = "grid grid-cols-1 gap-3";
                cat.i.forEach(item => {
                    const el = document.createElement('div');
                    el.className = "bg-white p-4 rounded-xl shadow-sm flex justify-between items-center cursor-pointer active:scale-[0.98]";
                    el.onclick = () => window.openNoteModal(item);
                    el.innerHTML = `<div><div class="text-gray-800 font-bold">${item.n}</div>${item.t ? `<div class="text-xs text-gray-500">${item.t}</div>` : ''}</div><span class="font-bold text-blue-600 text-lg">$${item.p}</span>`;
                    g.appendChild(el);
                });
                s.appendChild(g); c.appendChild(s);
            });
        };

        window.openNoteModal = function(item) {
            tempItem = item;
            document.getElementById('note-item-name').textContent = item.n;
            document.getElementById('note-item-trans').textContent = item.t || '';
            document.getElementById('note-item-price').textContent = `$${item.p}`;
            const c = document.getElementById('opt-container'); c.innerHTML = "";
            const opts = ["å°‘è¾£", "ä¸­è¾£", "å¤§è¾£", "èµ°å†°", "å°‘å†°", "å¤šå†°", "èµ°ç”œ", "å°‘ç”œ", "åŠç³–", "èµ°å¥¶", "èµ°è”¥", "èµ°èŠ«è½"];
            opts.forEach(o => c.innerHTML += `<div class="option-tag" onclick="window.toggleOption(this)"><i class="fas fa-check check-icon"></i><span>${o}</span></div>`);
            document.getElementById('note-other-input').value = "";
            document.getElementById('note-modal').classList.remove('hidden');
        };
        window.closeNoteModal = function() { document.getElementById('note-modal').classList.add('hidden'); tempItem = null; };
        window.toggleOption = function(el) { el.classList.toggle('active'); };
        window.toggleOther = function(el) {
            el.classList.toggle('active'); const i = document.getElementById('note-other-input');
            i.disabled = !el.classList.contains('active'); i.classList.toggle('bg-white', !i.disabled); i.classList.toggle('bg-gray-50', i.disabled); if(!i.disabled) i.focus();
        };

        window.confirmAddItem = function() {
            if (!tempItem) return;
            let notes = [];
            document.querySelectorAll('.option-tag.active').forEach(tag => { 
                const t = tag.innerText.trim();
                notes.push(optMap[t] || t);
            });
            const other = document.getElementById('note-other-input').value.trim(); if(other) notes.push(other);
            myCart.push({ _id: tempItem._id, n: tempItem.n, p: tempItem.p, o: notes.join(',') });
            window.updateCartBadge(); window.closeNoteModal();
            Swal.fire({icon: 'success', title: 'å·²åŠ å…¥', timer: 800, showConfirmButton: false});
        };

        window.updateCartBadge = function() {
            const count = myCart.length; document.getElementById('cartCount').innerText = count;
            document.getElementById('cartCount').style.display = count > 0 ? 'flex' : 'none';
        };

        window.checkOut = async function() {
            if (myCart.length === 0) return Swal.fire('è³¼ç‰©è»Šç©ºçš„', 'è«‹å…ˆé»é¤', 'warning');
            if (!userInfo.name || !userInfo.phone) {
                const { value: vals } = await Swal.fire({
                    title: 'è¨‚è³¼äººè³‡æ–™',
                    html: `<input id="swal-1" class="swal2-input" placeholder="åå­—" value="${userInfo.name||''}"><input id="swal-2" class="swal2-input" type="tel" placeholder="é›»è©±å¾Œ3ç¢¼" value="${userInfo.phone||''}">`,
                    focusConfirm: false, allowOutsideClick: false, preConfirm: () => {
                        const n = document.getElementById('swal-1').value, p = document.getElementById('swal-2').value;
                        if (!n || !p) { Swal.showValidationMessage('è«‹å¡«å¯«å®Œæ•´è³‡æ–™'); return false; } return [n, p];
                    }
                });
                if (vals) { userInfo.name = vals[0]; userInfo.phone = vals[1]; localStorage.setItem('lunch_captain_user', JSON.stringify(userInfo)); window.updateUserDisplay(); window.openCartModal(); }
            } else window.openCartModal();
        };

        window.openCartModal = function() {
            const list = document.getElementById('cart-list'); list.innerHTML = ""; let total = 0;
            myCart.forEach((item, idx) => {
                total += item.p;
                const noteDisplay = item.o.split(',').map(c => revOptMap[c] || c).filter(c=>c).join(', ');
                list.innerHTML += `<div class="flex justify-between items-center bg-gray-50 p-2 rounded border border-gray-100 mb-2"><div class="flex-1"><div class="font-bold text-gray-800 text-sm">${item.n}</div><div class="text-xs text-orange-500">${noteDisplay}</div><div class="text-xs text-blue-600 font-bold">$${item.p}</div></div><button onclick="window.removeFromCart(${idx})" class="text-red-400 p-2"><i class="fas fa-trash-alt"></i></button></div>`;
            });
            document.getElementById('cart-total-price').textContent = `$${total}`;
            const hint = document.getElementById('cart-action-hint'); const btn = document.getElementById('btn-final-submit');
            if (isCaptainMode) {
                hint.innerText = "åœ˜é•·ï¼šç¢ºèªç„¡èª¤ â” åŠ å…¥ç¸½è¡¨"; hint.className = "text-xs text-center text-blue-600 font-bold bg-blue-50 py-2 rounded mb-3 border border-blue-100";
                btn.innerHTML = 'åŠ å…¥ç¸½è¡¨'; btn.className = "btn text-sm text-lg shadow-lg animate-pulse text-white bg-blue-600"; 
            } else {
                hint.innerText = "åŒäº‹ï¼šç¢ºèªç„¡èª¤ â” ç”Ÿæˆ QR CODE"; hint.className = "text-xs text-center text-green-600 font-bold bg-green-50 py-2 rounded mb-3 border border-green-100";
                btn.innerHTML = 'ç”Ÿæˆ QR CODE'; btn.className = "btn text-sm text-lg shadow-lg animate-pulse text-white bg-green-600"; 
            }
            document.getElementById('cart-modal').classList.remove('hidden');
        };

        window.closeCartModal = function() { document.getElementById('cart-modal').classList.add('hidden'); };
        window.removeFromCart = function(idx) { myCart.splice(idx, 1); window.updateCartBadge(); if(myCart.length===0) window.closeCartModal(); else window.openCartModal(); };

        window.finalSubmit = function() {
            window.closeCartModal();
            if (isCaptainMode) {
                const items = myCart.map(m => ({ i: m._id, o: m.o }));
                window.addOrderToSystem(`${userInfo.name}-${userInfo.phone}`, { n:userInfo.name, t:userInfo.phone, d:items });
                myCart = []; window.updateCartBadge(); Swal.fire('æˆåŠŸ', 'å·²åŠ å…¥ç¸½è¡¨', 'success');
            } else window.generateOrderTicket();
        };

        window.generateOrderTicket = function() {
            let total = 0;
            const itemsHtml = myCart.map(i => {
                total += i.p;
                const displayNote = i.o.split(',').map(c => revOptMap[c] || c).join(', ');
                return `<div class="border-b pb-1 mb-1"><div class="flex justify-between"><span>${i.n}</span><span>$${i.p}</span></div><span class="text-xs text-orange-500">${displayNote}</span></div>`;
            }).join("");
            const simpleItems = myCart.map(m => [m._id, m.o]); 
            const payload = [userInfo.name, userInfo.phone, simpleItems];
            const orderStr = JSON.stringify(payload);
            document.getElementById('ticket-store').textContent = menuData.r;
            document.getElementById('ticket-name').textContent = userInfo.name;
            document.getElementById('ticket-phone').textContent = userInfo.phone;
            document.getElementById('ticket-items').innerHTML = itemsHtml;
            document.getElementById('ticket-total').textContent = "$" + total;
            document.getElementById('ticket-raw-code').value = orderStr;
            document.getElementById('ticket-modal').classList.remove('hidden');
            const qr = document.getElementById('orderQRCode'); qr.innerHTML = "";
            setTimeout(() => new QRCode(qr, { text: orderStr, width: 180, height: 180, correctLevel: QRCode.CorrectLevel.L }), 100);
        };

        window.onScanSuccess = function(decodedText) {
            try {
                let order = {};
                const data = JSON.parse(decodedText);
                if (Array.isArray(data)) {
                    order = { n: data[0], t: data[1], d: data[2].map(x => ({ i: x[0], o: x[1] })) };
                } else { order = data; }
                if (!order.n || !order.d) throw new Error();
                if(html5QrcodeScanner) html5QrcodeScanner.pause();
                window.addOrderToSystem(`${order.n}-${order.t}`, order);
                Swal.fire({icon: 'success', title: `${order.n} å·²åŠ å…¥`, timer: 1000, showConfirmButton: false});
                if(html5QrcodeScanner) html5QrcodeScanner.resume();
            } catch (e) { if(!html5QrcodeScanner) Swal.fire("æ ¼å¼éŒ¯èª¤", "è«‹ç¢ºèªä»£ç¢¼", "error"); }
        };

        window.updateUserDisplay = function() { document.getElementById('displayRoleName').textContent = userInfo.name; document.getElementById('displayRolePhone').textContent = userInfo.phone; document.getElementById('guestInfoDisplay').classList.remove('hidden'); };
        window.resetGuestInfo = function() { userInfo = { name: '', phone: '' }; localStorage.removeItem('lunch_captain_user'); document.getElementById('guestInfoDisplay').classList.add('hidden'); Swal.fire('å·²é‡ç½®', 'è«‹é‡æ–°è¼¸å…¥è³‡æ–™', 'info'); };
        window.copyTicketCode = function() { const c = document.getElementById('ticket-raw-code'); c.select(); document.execCommand("copy"); Swal.fire('å·²è¤‡è£½', '', 'success'); };
        window.shareTicketCode = function() { if(navigator.share) navigator.share({title:'é»é¤å–®', text:document.getElementById('ticket-raw-code').value}); else Swal.fire('ä¸æ”¯æ´', 'è«‹è¤‡è£½', 'info'); };
        window.downloadTicket = function() { html2canvas(document.getElementById('ticket-content')).then(c => { const a = document.createElement('a'); a.download = `Order.png`; a.href = c.toDataURL(); a.click(); }); };
        window.sendToWhatsapp = function() { window.location.href = `whatsapp://send?text=${encodeURIComponent(document.getElementById('ticket-raw-code').value)}`; };
        window.startScanner = function() { document.getElementById('scanner-modal').classList.remove('hidden'); html5QrcodeScanner = new Html5Qrcode("reader"); html5QrcodeScanner.start({facingMode:"environment"}, {fps:10, qrbox:250}, window.onScanSuccess); };
        window.stopScanner = function() { if(html5QrcodeScanner) html5QrcodeScanner.stop().then(() => { document.getElementById('scanner-modal').classList.add('hidden'); html5QrcodeScanner=null; }); else document.getElementById('scanner-modal').classList.add('hidden'); };
        window.manualImportOrder = function() { const v = document.getElementById('manualOrderInput').value.trim(); if(v) window.onScanSuccess(v); document.getElementById('manualOrderInput').value = ""; };

        window.addOrderToSystem = function(key, orderData) {
            const idMap = {};
            menuData.m.forEach(c => c.i.forEach(it => idMap[it._id] = it));
            const fullItems = orderData.d.map(item => {
                const ref = idMap[item.i];
                if (!ref) return null;
                const noteDisplay = (item.o || "").split(',').map(c => revOptMap[c] || c).filter(c=>c).join(', ');
                return { n: ref.n, p: ref.p, o: noteDisplay };
            }).filter(i => i);
            if (allOrders[key]) allOrders[key].d = allOrders[key].d.concat(fullItems);
            else allOrders[key] = { n: orderData.n, paid: false, d: fullItems };
            window.updateOrderBadge();
            if(!document.getElementById('summary-panel').classList.contains('hidden')) window.showSummary();
        };

        window.updateOrderBadge = function() { const c = Object.keys(allOrders).length; document.getElementById('orderCountBadge').innerText = c; document.getElementById('orderCountBadge').style.display = c>0?'flex':'none'; };
        window.showSummary = function() {
            const c = document.getElementById('summary-content'); c.innerHTML = ""; let gt = 0;
            const addBtn = document.createElement('button'); addBtn.className = "w-full border-2 border-dashed border-gray-300 text-gray-500 p-3 rounded-lg mb-4 text-sm hover:border-blue-500 flex items-center justify-center";
            addBtn.innerHTML = `<span><i class='fas fa-plus mr-2'></i> æ‰‹å‹•è¼¸å…¥ä»£ç¢¼</span>`; addBtn.onclick = () => { document.getElementById('summary-panel').classList.add('hidden'); window.startScanner(); };
            c.appendChild(addBtn);
            Object.entries(allOrders).forEach(([k, o]) => {
                const sub = o.d.reduce((s, i) => s + i.p, 0); gt += sub;
                const items = o.d.map(i => `<div class='flex justify-between text-sm text-gray-600 pl-3 border-l-2 border-gray-100 py-1'><span>${i.n} ${i.o?`<span class='text-orange-500 text-xs'>(${i.o})</span>`:''}</span><span>$${i.p}</span></div>`).join("");
                c.innerHTML += `<div class="p-4 rounded-xl border-2 mb-3 ${o.paid?'bg-green-50 border-green-200':'bg-white border-gray-100'}"><div class="flex justify-between items-center mb-2"><div class="flex items-center gap-3"><input type="checkbox" class="w-5 h-5 accent-green-600" ${o.paid?'checked':''} onchange="window.togglePaid('${k}')"><span class="font-bold text-lg ${o.paid?'text-green-700 line-through':''}">${o.n}</span></div><span class="font-bold text-blue-600">$${sub}</span></div>${items}</div>`;
            });
            document.getElementById('grand-total').textContent = "$" + gt; document.getElementById('summary-panel').classList.remove('hidden');
        };
        window.togglePaid = function(k) { if(allOrders[k]) { allOrders[k].paid = !allOrders[k].paid; window.showSummary(); } };
        window.copyForRestaurant = function() {
            let sum = {}; let t = 0; Object.values(allOrders).forEach(o => o.d.forEach(i => { const k=i.n+(i.o?` (${i.o})`:''); if(!sum[k]) sum[k]={c:0,p:i.p}; sum[k].c++; t+=i.p; }));
            let txt = `ğŸ“… è¨‚å–®ï¼š${menuData.r}\nâ”â”â”â”â”â”â”â”â”â”â”â”\n`; for(const[n,d]of Object.entries(sum)) txt+=`${n} x ${d.c}\n`; txt+=`â”â”â”â”â”â”â”â”â”â”â”â”\nğŸ’° ç¸½é‡‘é¡ï¼š$${t}`;
            window.location.href = `whatsapp://send?text=${encodeURIComponent(txt)}`;
        };
        window.copyForGroup = function() {
            let txt = `ğŸ“‹ æ”¶éŒ¢ (${menuData.r})\nâ”â”â”â”â”â”â”â”â”â”â”â”\n`; let t = 0; let p = 0;
            Object.values(allOrders).forEach(o => { const s=o.d.reduce((a,b)=>a+b.p,0); t+=s; if(o.paid)p++; txt+=`${o.paid?'âœ…':'â¬œ'} ${o.n}: $${s}\n`; });
            txt+=`â”â”â”â”â”â”â”â”â”â”â”â”\nğŸ’° ç¸½è¨ˆ: $${t}\n(å·²ä»˜:${p}/æœªä»˜:${Object.keys(allOrders).length-p})`;
            navigator.clipboard.writeText(txt).then(() => Swal.fire('å·²è¤‡è£½', '', 'success'));
        };
        window.shareSystem = async function() { if(navigator.share) await navigator.share({title:'é»é¤', text:`é¤å»³:${menuData.r}`, url:window.location.href}); else Swal.fire('ä¸æ”¯æ´', '', 'info'); };

        // å•Ÿå‹•!
        window.onload = function() {
            initHybridSystem();
            if(window.location.hash === "#import_menu") { document.getElementById('setup-panel').scrollIntoView(); document.getElementById('jsonInput').focus(); history.replaceState(null, null, ' '); }
        };
    </script>
</body>
</html>
