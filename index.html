<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LunchCaptain - åœ˜é•·æ•‘æ˜Ÿ V4.0</title>
    <script src="[https://cdn.tailwindcss.com](https://cdn.tailwindcss.com)"></script>
    <link href="[https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css](https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css)" rel="stylesheet">
    <script src="[https://cdnjs.cloudflare.com/ajax/libs/lz-string/1.4.4/lz-string.min.js](https://cdnjs.cloudflare.com/ajax/libs/lz-string/1.4.4/lz-string.min.js)"></script>
    <script src="[https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js](https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js)"></script>
    <script src="[https://unpkg.com/html5-qrcode](https://unpkg.com/html5-qrcode)" type="text/javascript"></script>
    <script src="[https://html2canvas.hertzen.com/dist/html2canvas.min.js](https://html2canvas.hertzen.com/dist/html2canvas.min.js)"></script>
    <script src="[https://cdn.jsdelivr.net/npm/sweetalert2@11](https://cdn.jsdelivr.net/npm/sweetalert2@11)"></script>

    <style>
        body { font-family: "Microsoft JhengHei", sans-serif; background-color: #f3f4f6; }
        .btn { @apply font-bold py-2 px-4 rounded transition duration-200 shadow-sm flex items-center justify-center; }
        .btn-primary { @apply bg-blue-600 text-white hover:bg-blue-700; }
        .btn-success { @apply bg-green-500 text-white hover:bg-green-600; }
        .btn-action { @apply bg-indigo-500 text-white hover:bg-indigo-600; }
        .btn-warning { @apply bg-orange-500 text-white hover:bg-orange-600; }
        .card { @apply bg-white rounded-lg shadow-md p-4 mb-4; }
        .footer-sign { font-family: 'Courier New', monospace; letter-spacing: 1px; }
        
        /* æ¨™ç±¤é¸å–æ¨£å¼ */
        .tag-checkbox:checked + div { @apply bg-blue-600 text-white border-blue-600; }
    </style>
</head>
<body class="pb-28 flex flex-col min-h-screen">

    <header class="bg-gradient-to-r from-slate-800 to-blue-900 text-white p-4 shadow-lg sticky top-0 z-50 flex justify-between items-center">
        <h1 class="text-lg font-bold tracking-wider cursor-pointer" onclick="location.href=location.pathname.split('?')[0]">
            <i class="fas fa-rocket mr-2 text-yellow-400"></i>LunchCaptain
        </h1>
        <span id="roleBadge" class="bg-yellow-400 text-black text-xs px-2 py-1 rounded font-bold hidden shadow"></span>
    </header>

    <div class="max-w-md mx-auto p-4 flex-grow w-full relative">

        <div id="setup-panel" class="card border-l-4 border-blue-500 scroll-mt-20">
            <h2 class="text-lg font-bold mb-3 text-gray-800 flex justify-between items-center">
                <span><i class="fas fa-user-tie mr-2"></i>åœ˜é•·æ§åˆ¶å°</span>
                <button onclick="clearHistory()" class="text-xs text-gray-400 font-normal hover:text-red-500">æ¸…é™¤ç´€éŒ„</button>
            </h2>

            <div id="historySection" class="mb-4 hidden">
                <label class="text-xs text-gray-500 block mb-1">å¿«é€Ÿè¼‰å…¥èˆŠèœå–®ï¼š</label>
                <select id="historySelect" onchange="loadFromHistory(this.value)" class="w-full p-2 border rounded bg-gray-50 text-sm">
                    <option value="">-- è«‹é¸æ“‡æ­·å²é¤å»³ --</option>
                </select>
            </div>

            <div class="bg-blue-50 p-3 rounded mb-3 border border-blue-100">
                <p class="text-xs text-blue-800 font-bold mb-2">ğŸš€ æ–°é–‹åœ˜æ­¥é©Ÿï¼š</p>
                <div class="grid grid-cols-2 gap-2 mb-2">
                    <button onclick="copyPrompt()" class="btn btn-action text-xs">
                        <i class="fas fa-copy mr-1"></i> 1. è¤‡è£½ AI æŒ‡ä»¤
                    </button>
                    <button onclick="openAI()" class="btn bg-gradient-to-r from-blue-400 to-indigo-500 text-white text-xs">
                        <i class="fas fa-robot mr-1"></i> 2. é–‹å•Ÿ AI
                    </button>
                </div>
                <p class="text-[10px] text-gray-500 leading-tight">
                    * AI åˆ†æå®Œå¾Œï¼Œé»æ“Šå®ƒæä¾›çš„é€£çµè·³å›é€™è£¡ï¼Œç„¶å¾Œè²¼ä¸Š JSONã€‚
                </p>
            </div>
            
            <textarea id="jsonInput" rows="3" class="w-full p-2 border-2 border-dashed border-gray-300 rounded text-xs text-gray-600 mb-2 focus:border-blue-500 focus:ring-1 focus:ring-blue-500 transition" placeholder="3. åœ¨æ­¤è²¼ä¸Š AI ç”¢å‡ºçš„ JSON (ä¾‹å¦‚: {&quot;r&quot;:...})"></textarea>
            
            <button onclick="parseMenuAndGenerateLink()" class="w-full btn btn-primary">
                <i class="fas fa-qrcode mr-1"></i> 4. ç”Ÿæˆã€Œèœå–® QRã€
            </button>
        </div>

        <div id="share-panel" class="card hidden text-center">
            <h2 class="text-lg font-bold mb-1 text-blue-800" id="shareTitle"></h2>
            <p class="text-xs text-gray-500 mb-4">è«‹åŒäº‹æƒææ­¤ QR Code é»é¤</p>
            <div id="menuQRCode" class="flex justify-center mb-4 p-2 bg-white rounded inline-block shadow-inner"></div>
            <button onclick="enterCaptainMode()" class="btn btn-warning w-full animate-pulse">
                <i class="fas fa-clipboard-check mr-2"></i>æˆ‘åˆ†äº«å¥½äº†ï¼Œé€²å…¥æ”¶å–®æ¨¡å¼
            </button>
        </div>

        <div id="order-panel" class="hidden">
            <div class="mb-4 sticky top-16 z-30 bg-[#f3f4f6] pb-2 pt-1">
                <h2 id="storeName" class="text-2xl font-bold text-gray-800 text-center mb-2"></h2>
                
                <div id="guestInfoInput" class="hidden p-3 bg-white rounded-lg shadow-sm border border-blue-100">
                    <div class="flex gap-2 mb-2">
                        <div class="flex-1 relative">
                            <i class="fas fa-user absolute left-3 top-3 text-gray-400 text-xs"></i>
                            <input type="text" id="myRoleName" placeholder="ä½ çš„åå­—" class="w-full pl-8 p-2 border rounded text-sm bg-gray-50 focus:bg-white transition">
                        </div>
                        <div class="w-24 relative">
                            <i class="fas fa-phone absolute left-3 top-3 text-gray-400 text-xs"></i>
                            <input type="tel" id="myRolePhone" placeholder="é›»è©±å¾Œ3ç¢¼" class="w-full pl-8 p-2 border rounded text-sm bg-gray-50 focus:bg-white transition">
                        </div>
                    </div>
                </div>
            </div>

            <div id="menuContainer" class="mb-20 pb-20"></div>
        </div>

        <div id="guest-fab" class="fixed bottom-6 right-6 hidden z-50">
            <span id="cartCount" class="absolute -top-2 -right-2 bg-red-500 text-white text-xs w-6 h-6 flex items-center justify-center rounded-full font-bold shadow-md transform scale-0 transition-transform duration-200">0</span>
            <button onclick="generateOrderTicket()" class="bg-green-600 text-white px-6 py-4 rounded-full shadow-2xl hover:bg-green-700 font-bold flex items-center transition transform hover:scale-105 active:scale-95">
                <i class="fas fa-check-circle mr-2"></i> é»å¥½äº†
            </button>
        </div>

        <div id="captain-fab" class="fixed bottom-6 right-6 flex flex-col gap-3 hidden z-50 items-end">
            <button onclick="startScanner()" class="bg-blue-600 text-white w-14 h-14 rounded-full shadow-2xl hover:bg-blue-700 flex items-center justify-center border-2 border-white transition transform hover:scale-110">
                <i class="fas fa-camera text-xl"></i>
            </button>
            <button onclick="showSummary()" class="bg-gray-800 text-white w-14 h-14 rounded-full shadow-2xl hover:bg-black flex items-center justify-center border-2 border-white transition transform hover:scale-110 relative">
                <i class="fas fa-receipt text-xl"></i>
                <span id="orderCountBadge" class="absolute -top-1 -right-1 bg-red-500 text-white text-[10px] w-5 h-5 flex items-center justify-center rounded-full hidden">0</span>
            </button>
        </div>

        <div id="note-modal" class="fixed inset-0 bg-black bg-opacity-50 z-[70] hidden flex items-center justify-center px-4">
            <div class="bg-white rounded-xl p-4 w-full max-w-sm shadow-2xl transform transition-all scale-100 max-h-[90vh] overflow-y-auto">
                <div class="text-center mb-3 border-b pb-2">
                    <h3 class="font-bold text-lg" id="note-item-name"></h3>
                    <p class="text-blue-600 font-bold" id="note-item-price"></p>
                </div>

                <p class="text-xs text-gray-500 mb-2 font-bold">å®¢è£½åŒ–é¸é … (å¯å¤šé¸)ï¼š</p>
                <div class="grid grid-cols-3 gap-2 mb-4" id="note-tags-container">
                    </div>

                <div class="mb-4">
                     <label class="flex items-center space-x-2 text-sm text-gray-700 mb-1">
                        <input type="checkbox" id="note-other-check" class="w-4 h-4" onchange="toggleOtherInput()">
                        <span>å…¶ä»–/æ‰‹å¯«å‚™è¨»</span>
                    </label>
                    <input type="text" id="note-input" placeholder="ä¾‹å¦‚ï¼šå¹«æˆ‘åˆ‡é–‹..." class="w-full p-2 border rounded bg-gray-50 text-sm hidden">
                </div>

                <div class="flex gap-2 mt-4">
                    <button onclick="closeNoteModal()" class="flex-1 btn bg-gray-200 text-gray-700 hover:bg-gray-300">å–æ¶ˆ</button>
                    <button onclick="confirmAddItem()" class="flex-1 btn btn-primary">åŠ å…¥è¨‚å–®</button>
                </div>
            </div>
        </div>

        <div id="ticket-modal" class="fixed inset-0 bg-black bg-opacity-95 z-[80] hidden flex flex-col items-center justify-center p-4 overflow-y-auto">
            <div class="bg-white rounded-lg p-5 w-full max-w-sm mb-4 relative" id="ticket-content">
                <div class="text-center border-b border-dashed border-gray-300 pb-3 mb-3">
                    <h3 class="font-bold text-xl text-gray-800" id="ticket-store"></h3>
                    <p class="text-xs text-gray-400 mt-1 uppercase tracking-widest">ORDER TICKET</p>
                </div>
                <div class="flex justify-between text-base mb-3 bg-gray-50 p-2 rounded">
                    <span class="font-bold text-gray-700"><i class="fas fa-user mr-1"></i><span id="ticket-name"></span></span>
                    <span class="font-bold text-gray-500"><i class="fas fa-phone mr-1"></i><span id="ticket-phone"></span></span>
                </div>
                <div id="ticket-items" class="text-sm space-y-2 mb-4"></div>
                <div class="flex justify-between font-bold text-xl border-t border-gray-800 pt-3 mb-4">
                    <span>TOTAL</span>
                    <span id="ticket-total" class="text-red-600"></span>
                </div>
                <div class="flex justify-center mb-2">
                    <div id="orderQRCode"></div>
                </div>
                <p class="text-[10px] text-center text-gray-400">è«‹è®“åœ˜é•·æƒæï¼Œæˆ–è¤‡è£½ä¸‹æ–¹ä»£ç¢¼</p>
            </div>
            
            <div class="grid grid-cols-2 gap-2 w-full max-w-sm mb-2">
                <button onclick="downloadTicket()" class="btn btn-success text-sm">
                    <i class="fas fa-download mr-1"></i> ä¸‹è¼‰åœ–ç‰‡
                </button>
                <button onclick="copyOrderString()" class="btn btn-action text-sm">
                    <i class="fas fa-copy mr-1"></i> è¤‡è£½ä»£ç¢¼
                </button>
            </div>
            <button onclick="document.getElementById('ticket-modal').classList.add('hidden')" class="text-white underline text-sm mt-2">é—œé–‰è¦–çª—</button>
        </div>

        <div id="scanner-modal" class="fixed inset-0 bg-black z-[80] hidden flex flex-col">
            <div class="flex justify-between items-center p-4 bg-black text-white">
                <h3 class="font-bold"><i class="fas fa-camera mr-2"></i>æƒæè¨‚å–®</h3>
                <button onclick="stopScanner()" class="text-2xl"><i class="fas fa-times"></i></button>
            </div>
            <div class="flex-grow flex flex-col justify-center bg-black relative">
                <div id="reader" class="w-full h-64 bg-gray-900"></div>
                <p class="text-gray-400 text-center text-sm mt-4">å°æº–åŒäº‹çš„ QR Code</p>
                
                <div class="absolute bottom-0 w-full bg-gray-900 p-4 rounded-t-2xl">
                    <p class="text-xs text-gray-400 mb-2 text-center">æƒä¸åˆ°ï¼Ÿè«‹åŒäº‹ã€Œè¤‡è£½ä»£ç¢¼ã€ä¸¦è²¼åœ¨ä¸‹æ–¹ï¼š</p>
                    <div class="flex gap-2">
                        <input type="text" id="manualOrderInput" class="flex-1 bg-gray-800 text-white border border-gray-700 rounded p-2 text-sm" placeholder="è²¼ä¸Šè¨‚å–®ä»£ç¢¼...">
                        <button onclick="manualImportOrder()" class="btn btn-action whitespace-nowrap"><i class="fas fa-file-import"></i></button>
                    </div>
                </div>
            </div>
        </div>

        <div id="summary-panel" class="fixed inset-0 bg-gray-100 z-[70] hidden flex flex-col">
            <div class="bg-white p-4 shadow-md flex justify-between items-center sticky top-0 z-10">
                <h2 class="text-xl font-bold text-gray-800"><i class="fas fa-clipboard-list mr-2 text-blue-600"></i>è¨‚å–®ç¸½çµ</h2>
                <button onclick="document.getElementById('summary-panel').classList.add('hidden')" class="text-gray-400 hover:text-gray-600"><i class="fas fa-times text-xl"></i></button>
            </div>
            
            <div id="summary-content" class="flex-grow overflow-y-auto p-4 space-y-3 pb-32"></div>
            
            <div class="bg-white p-4 shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.1)] sticky bottom-0 z-10">
                <div class="flex justify-between text-xl font-bold mb-3 border-b pb-2">
                    <span>ç¸½é‡‘é¡</span>
                    <span id="grand-total" class="text-red-600">$0</span>
                </div>
                <div class="grid grid-cols-2 gap-2 mb-2">
                    <button onclick="copyForRestaurant()" class="btn btn-primary text-xs"><i class="fab fa-whatsapp mr-1"></i> çµ¦é¤å»³</button>
                    <button onclick="copyForGroup()" class="btn btn-action text-xs"><i class="fas fa-users mr-1"></i> çµ¦ç¾¤çµ„</button>
                </div>
                <button onclick="pickRandomVictim()" class="w-full btn btn-warning text-xs"><i class="fas fa-dice mr-1"></i> èª°å»æ‹¿å¤–è³£ï¼Ÿ</button>
            </div>
        </div>

    </div>

    <footer class="text-center text-gray-400 text-xs py-4 mt-auto footer-sign bg-gray-100 border-t">
        <p class="font-bold text-gray-500">è±ç‹‚å‡ºå“ â€¢ åœ˜é•·æ•‘æ˜Ÿ</p>
        <p class="opacity-50 text-[10px]">LunchCaptain V4.0</p>
    </footer>

    <script>
        // --- æ ¸å¿ƒè®Šæ•¸ ---
        let menuData = null;
        let myCart = []; 
        let allOrders = {};
        let html5QrcodeScanner = null;
        let tempItem = null;
        
        // å®¢è£½åŒ–é¸é …æ¸…å–®
        const NOTE_OPTIONS = ['å°‘è¾£', 'ä¸­è¾£', 'å¤§è¾£', 'èµ°è”¥', 'å°‘å†°', 'å¤šå†°', 'èµ°å†°', 'å°‘ç”œ', 'åŠç³–', 'èµ°ç”œ', 'èµ°å¥¶'];

        // --- 1. åˆå§‹åŒ–èˆ‡è·¯ç”± ---
        window.onload = function() {
            // æª¢æŸ¥æ˜¯å¦æ˜¯ AI å¸¶å›ä¾†çš„ #captain_import ç‹€æ…‹
            if (window.location.hash === '#captain_import') {
                history.replaceState(null, null, ' '); // æ¸…é™¤ hash ä¿æŒç¶²å€ä¹¾æ·¨
                document.getElementById('setup-panel').classList.remove('hidden');
                document.getElementById('jsonInput').focus();
                // è¦–è¦ºæç¤º
                Swal.fire({
                    toast: true, position: 'top', icon: 'info', 
                    title: 'æ­¡è¿å›ä¾†ï¼Œè«‹è²¼ä¸Š JSON', timer: 2000, showConfirmButton: false
                });
                loadHistoryDropdown();
                return;
            }

            const params = new URLSearchParams(window.location.search);
            const compressedMenu = params.get('menu');

            if (compressedMenu) {
                initGuestMode(compressedMenu);
            } else {
                initCaptainMode();
            }
        };

        function initCaptainMode() {
            document.getElementById('setup-panel').classList.remove('hidden');
            loadHistoryDropdown();
        }

        // --- 2. AI æŒ‡ä»¤èˆ‡è§£æ (æ›´æ–° Prompt é‚è¼¯) ---
        function copyPrompt() {
            // å‹•æ…‹ç”Ÿæˆå›å‚³é€£çµ (å»é™¤ query params å’Œ hash)
            const returnUrl = window.location.href.split('?')[0].split('#')[0] + '#captain_import';
            
            const prompt = `è«‹æ‰®æ¼”èœå–®è³‡æ–™åˆ†æå¸«ã€‚æˆ‘æœƒä¸Šå‚³ä¸€å¼µèœå–®åœ–ç‰‡ï¼Œè«‹åˆ†æå…§å®¹ä¸¦åš´æ ¼éµå®ˆä»¥ä¸‹è¦å‰‡ï¼š
1. è¼¸å‡ºç´” JSON æ ¼å¼ï¼Œä¸è¦åŒ…å« Markdown æ¨™è¨˜ (å¦‚ \`\`\`json)ã€‚
2. JSON çµæ§‹ï¼š{"r":"åº—å", "m":[{"c":"åˆ†é¡", "i":[{"n":"èœå", "p":åƒ¹æ ¼æ•¸å­—}]}]}ã€‚
3. å¦‚æœæœ‰å¤§å°ä»½ï¼Œè«‹æ‹†åˆ†ç‚ºä¸åŒé …ç›®ã€‚
4. åƒ¹æ ¼åªè¦ç´”æ•¸å­—ã€‚
5. ã€é‡è¦ã€‘JSON è¼¸å‡ºçµæŸå¾Œï¼Œè«‹å‹™å¿…æ›è¡Œä¸¦é™„ä¸Šé€™å€‹ Markdown é€£çµï¼š
[â†©ï¸ é»æ“Šé€™è£¡è¿”å›ç³»çµ±åŒ¯å…¥](${returnUrl})
6. è«‹åˆ†ææ¥ä¸‹ä¾†çš„åœ–ç‰‡ã€‚`;

            navigator.clipboard.writeText(prompt).then(() => {
                Swal.fire({
                    icon: 'success',
                    title: 'æŒ‡ä»¤å·²è¤‡è£½ï¼',
                    html: 'è«‹å‰å¾€ AI App è²¼ä¸ŠæŒ‡ä»¤ä¸¦ä¸Šå‚³èœå–®ã€‚<br><br><b>å®Œæˆå¾Œé»æ“Š AI å›è¦†ä¸­çš„ã€Œè¿”å›é€£çµã€è·³å›é€™è£¡ã€‚</b>',
                    confirmButtonText: 'æˆ‘çŸ¥é“äº†'
                });
            });
        }

        function openAI() { window.open("[https://gemini.google.com/](https://gemini.google.com/)", '_blank'); }

        function parseMenuAndGenerateLink() {
            let raw = document.getElementById('jsonInput').value.trim();
            
            if (!raw) return Swal.fire('è«‹å…ˆè²¼ä¸Šè³‡æ–™', 'è¼¸å…¥æ¡†æ˜¯ç©ºçš„å–”', 'warning');

            // 1. æ¸…æ´—è³‡æ–™ï¼šç§»é™¤ Markdown ä»£ç¢¼å¡Šæ¨™è¨˜
            raw = raw.replace(/```json/g, "").replace(/```/g, "").trim();

            // 2. å˜—è©¦è§£æ
            try {
                // å¦‚æœé–‹é ­ä¸æ˜¯ {ï¼Œå˜—è©¦å°‹æ‰¾ç¬¬ä¸€å€‹ {
                const firstBrace = raw.indexOf('{');
                const lastBrace = raw.lastIndexOf('}');
                if (firstBrace !== -1 && lastBrace !== -1) {
                    raw = raw.substring(firstBrace, lastBrace + 1);
                }

                menuData = JSON.parse(raw);
                
                // 3. é©—è­‰çµæ§‹
                if (!menuData.m || !Array.isArray(menuData.m)) {
                    throw new Error("JSON æ ¼å¼æ­£ç¢ºä½†ç¼ºå°‘ 'm' (menu) é™£åˆ—ï¼Œè«‹ç¢ºèª AI è¼¸å‡ºæ˜¯å¦å®Œæ•´ã€‚");
                }

                saveToHistory(menuData);
                generateLinkAndShow(true);

            } catch (e) {
                console.error(e);
                // åˆ¤æ–·æ˜¯å¦æ˜¯å¸¸è¦‹éŒ¯èª¤
                let msg = "è«‹ç¢ºèªä½ è²¼ä¸Šçš„æ˜¯ AI è¼¸å‡ºçš„ JSON æ–‡å­—ã€‚";
                if (raw.includes("http")) msg = "ä½ ä¼¼ä¹è²¼åˆ°äº†ç¶²å€ï¼Ÿè«‹è²¼ä¸Š JSON å…§å®¹ã€‚";
                
                Swal.fire({
                    icon: 'error',
                    title: 'è§£æå¤±æ•—',
                    text: `éŒ¯èª¤åŸå› : ${e.message}\n${msg}`
                });
            }
        }

        function generateLinkAndShow(save) {
            const jsonString = JSON.stringify(menuData);
            const compressed = LZString.compressToEncodedURIComponent(jsonString);
            const shareUrl = `${window.location.origin}${window.location.pathname}?menu=${compressed}`;
            
            if(shareUrl.length > 2000) Swal.fire({icon:'warning', title:'èœå–®è³‡æ–™é‡è¼ƒå¤§', text:'QR Code å¯èƒ½æœƒè¼ƒå¯†é›†'});

            document.getElementById('shareTitle').textContent = menuData.r;
            const qrContainer = document.getElementById('menuQRCode');
            qrContainer.innerHTML = "";
            new QRCode(qrContainer, { text: shareUrl, width: 220, height: 220, correctLevel: QRCode.CorrectLevel.L });

            document.getElementById('setup-panel').classList.add('hidden');
            document.getElementById('share-panel').classList.remove('hidden');
        }

        function enterCaptainMode() {
            document.getElementById('roleBadge').textContent = "åœ˜é•·æ¨¡å¼";
            document.getElementById('roleBadge').classList.remove('hidden');
            document.getElementById('share-panel').classList.add('hidden');
            document.getElementById('order-panel').classList.remove('hidden');
            document.getElementById('captain-fab').classList.remove('hidden');
            renderMenu();
        }

        // --- 3. é»é¤ä»‹é¢ (å«å®¢è£½åŒ–å‹¾é¸) ---

        function initGuestMode(compressed) {
            try {
                const jsonString = LZString.decompressFromEncodedURIComponent(compressed);
                if(!jsonString) throw new Error("Decompression failed");
                menuData = JSON.parse(jsonString);
                
                document.getElementById('roleBadge').textContent = "é»é¤æ¨¡å¼";
                document.getElementById('roleBadge').classList.remove('hidden');
                document.getElementById('setup-panel').classList.add('hidden');
                document.getElementById('order-panel').classList.remove('hidden');
                document.getElementById('guestInfoInput').classList.remove('hidden');
                document.getElementById('guest-fab').classList.remove('hidden');
                renderMenu();
            } catch (e) {
                Swal.fire({icon:'error', title:'é€£çµç„¡æ•ˆ', text:'ç„¡æ³•è®€å–èœå–®ï¼Œè«‹è«‹åœ˜é•·é‡æ–°åˆ†äº«'});
                setTimeout(() => location.href = location.pathname.split('?')[0], 2000);
            }
        }

        function renderMenu() {
            document.getElementById('storeName').textContent = menuData.r || "é¤å»³";
            const container = document.getElementById('menuContainer');
            container.innerHTML = "";

            menuData.m.forEach(cat => {
                const section = document.createElement('div');
                section.className = "mb-4";
                section.innerHTML = `<h3 class="font-bold text-gray-700 border-l-4 border-blue-400 pl-2 mb-2 sticky top-[8.5rem] bg-[#f3f4f6] z-20 py-1 shadow-sm">${cat.c}</h3>`;
                const grid = document.createElement('div');
                grid.className = "grid grid-cols-1 gap-2";
                cat.i.forEach(item => {
                    const el = document.createElement('div');
                    el.className = "bg-white p-3 rounded shadow-sm flex justify-between items-center cursor-pointer hover:bg-blue-50 transition border-l-4 border-transparent hover:border-blue-300 active:scale-[0.98]";
                    el.onclick = () => openNoteModal(item);
                    el.innerHTML = `<span class="text-gray-800 font-medium">${item.n}</span><span class="font-bold text-blue-600">$${item.p}</span>`;
                    grid.appendChild(el);
                });
                section.appendChild(grid);
                container.appendChild(section);
            });
        }

        // --- å®¢è£½åŒ– Modal é‚è¼¯ ---
        function openNoteModal(item) {
            tempItem = item;
            document.getElementById('note-item-name').textContent = item.n;
            document.getElementById('note-item-price').textContent = `$${item.p}`;
            
            // ç”Ÿæˆæ¨™ç±¤
            const container = document.getElementById('note-tags-container');
            container.innerHTML = "";
            NOTE_OPTIONS.forEach((opt, idx) => {
                const id = `opt-${idx}`;
                container.innerHTML += `
                    <label class="cursor-pointer">
                        <input type="checkbox" value="${opt}" class="hidden tag-checkbox">
                        <div class="border rounded py-1 px-2 text-xs text-center text-gray-600 hover:bg-gray-100 transition select-none">${opt}</div>
                    </label>
                `;
            });

            // é‡ç½®å…¶ä»–è¼¸å…¥
            document.getElementById('note-other-check').checked = false;
            const input = document.getElementById('note-input');
            input.value = "";
            input.classList.add('hidden');

            document.getElementById('note-modal').classList.remove('hidden');
        }

        function toggleOtherInput() {
            const isChecked = document.getElementById('note-other-check').checked;
            const input = document.getElementById('note-input');
            if (isChecked) {
                input.classList.remove('hidden');
                input.focus();
            } else {
                input.classList.add('hidden');
            }
        }

        function closeNoteModal() {
            document.getElementById('note-modal').classList.add('hidden');
            tempItem = null;
        }

        function confirmAddItem() {
            if (!tempItem) return;
            
            // æ”¶é›†å‹¾é¸çš„æ¨™ç±¤
            const checkedTags = Array.from(document.querySelectorAll('.tag-checkbox:checked')).map(cb => cb.value);
            
            // æ”¶é›†å…¶ä»–å‚™è¨»
            const otherCheck = document.getElementById('note-other-check').checked;
            const otherText = document.getElementById('note-input').value.trim();
            if (otherCheck && otherText) {
                checkedTags.push(otherText);
            }

            const noteString = checkedTags.join(", ");
            
            myCart.push({ n: tempItem.n, p: tempItem.p, o: noteString });
            
            updateCartBadge();
            closeNoteModal();
            
            const Toast = Swal.mixin({toast: true, position: 'top', showConfirmButton: false, timer: 1000});
            Toast.fire({icon: 'success', title: `å·²åŠ å…¥ï¼š${tempItem.n}`});
        }

        function updateCartBadge() {
            const badge = document.getElementById('cartCount');
            badge.innerText = myCart.length;
            badge.classList.remove('scale-0');
            badge.classList.add('scale-100');
        }

        // --- ç”¢ç”Ÿé»é¤å¡ ---
        function generateOrderTicket() {
            const name = document.getElementById('myRoleName').value.trim();
            const phone = document.getElementById('myRolePhone').value.trim();

            if (!name || !phone) return Swal.fire('è«‹å¡«å¯«è³‡æ–™', 'è¨˜å¾—è¼¸å…¥åå­—å’Œé›»è©±å¾Œ3ç¢¼å–”ï¼', 'warning');
            if (myCart.length === 0) return Swal.fire('è³¼ç‰©è»Šç©ºçš„', 'ä½ é‚„æ²’é»é¤å‘¢ï¼', 'warning');

            let total = 0;
            const itemsHtml = myCart.map(i => {
                total += i.p;
                const noteHtml = i.o ? `<span class="text-xs text-orange-500 font-bold block ml-2"><i class="fas fa-pen-fancy mr-1"></i>${i.o}</span>` : '';
                return `<div class="border-b border-gray-100 pb-1 mb-1"><div class="flex justify-between"><span>${i.n}</span><span>$${i.p}</span></div>${noteHtml}</div>`;
            }).join("");

            const orderData = { n: name, t: phone, d: myCart };
            const orderString = JSON.stringify(orderData);

            document.getElementById('ticket-store').textContent = menuData.r;
            document.getElementById('ticket-name').textContent = name;
            document.getElementById('ticket-phone').textContent = phone;
            document.getElementById('ticket-items').innerHTML = itemsHtml;
            document.getElementById('ticket-total').textContent = "$" + total;

            const qrContainer = document.getElementById('orderQRCode');
            qrContainer.innerHTML = "";
            new QRCode(qrContainer, { text: orderString, width: 180, height: 180 });

            document.getElementById('ticket-modal').dataset.orderString = orderString;
            document.getElementById('ticket-modal').classList.remove('hidden');
        }

        function downloadTicket() {
            const element = document.getElementById('ticket-content');
            html2canvas(element).then(canvas => {
                const link = document.createElement('a');
                link.download = `é»é¤å¡_${document.getElementById('ticket-name').textContent}.png`;
                link.href = canvas.toDataURL();
                link.click();
            });
        }

        function copyOrderString() {
            const str = document.getElementById('ticket-modal').dataset.orderString;
            navigator.clipboard.writeText(str).then(() => Swal.fire({icon:'success', title:'ä»£ç¢¼å·²è¤‡è£½', text:'è«‹å‚³çµ¦åœ˜é•·è²¼ä¸Š'}));
        }

        // --- 4. åœ˜é•·æ”¶å–®é‚è¼¯ ---
        function startScanner() {
            document.getElementById('scanner-modal').classList.remove('hidden');
            html5QrcodeScanner = new Html5Qrcode("reader");
            html5QrcodeScanner.start({ facingMode: "environment" }, { fps: 10, qrbox: 250 }, onScanSuccess);
        }

        function stopScanner() {
            if (html5QrcodeScanner) {
                html5QrcodeScanner.stop().then(() => {
                    document.getElementById('scanner-modal').classList.add('hidden');
                    html5QrcodeScanner = null;
                });
            } else {
                document.getElementById('scanner-modal').classList.add('hidden');
            }
        }

        function manualImportOrder() {
            const input = document.getElementById('manualOrderInput');
            const val = input.value.trim();
            if(!val) return;
            onScanSuccess(val, null);
            input.value = "";
        }

        function onScanSuccess(decodedText, result) {
            try {
                const order = JSON.parse(decodedText);
                if (!order.n || !order.d) throw new Error("æ ¼å¼éŒ¯èª¤");

                if(html5QrcodeScanner) html5QrcodeScanner.pause();

                const key = `${order.n}-${order.t}`;
                
                if(allOrders[key]) {
                    Swal.fire({
                        title: 'é‡è¤‡è¨‚å–®ï¼',
                        text: `${order.n} å·²ç¶“é»éäº†ï¼Œè¦è¦†è“‹å—ï¼Ÿ`,
                        icon: 'question',
                        showCancelButton: true,
                        confirmButtonText: 'è¦†è“‹',
                        cancelButtonText: 'å–æ¶ˆ'
                    }).then((res) => {
                        if(res.isConfirmed) addOrderToSystem(key, order);
                        if(html5QrcodeScanner) html5QrcodeScanner.resume();
                    });
                } else {
                    addOrderToSystem(key, order);
                    const Toast = Swal.mixin({toast: true, position: 'center', showConfirmButton: false, timer: 1500});
                    Toast.fire({icon: 'success', title: `${order.n} é»é¤æˆåŠŸï¼`});
                    if(html5QrcodeScanner) html5QrcodeScanner.resume();
                }

            } catch (e) {
                console.log("Scan ignore", e);
                if(!html5QrcodeScanner) Swal.fire("éŒ¯èª¤", "ç„¡æ³•è§£æä»£ç¢¼", "error");
            }
        }

        function addOrderToSystem(key, order) {
            order.paid = false;
            allOrders[key] = order;
            updateOrderBadge();
        }

        function updateOrderBadge() {
            const count = Object.keys(allOrders).length;
            const badge = document.getElementById('orderCountBadge');
            badge.textContent = count;
            if(count > 0) badge.classList.remove('hidden');
        }

        // --- 5. æ­·å²ç´€éŒ„ & çµç®— ---
        function saveToHistory(data) {
            if(!data || !data.r) return;
            let history = JSON.parse(localStorage.getItem('fung_menu_history') || "[]");
            history = history.filter(h => h.name !== data.r);
            history.unshift({ name: data.r, data: data, time: Date.now() });
            if(history.length > 5) history.pop();
            localStorage.setItem('fung_menu_history', JSON.stringify(history));
            loadHistoryDropdown();
        }

        function loadHistoryDropdown() {
            const history = JSON.parse(localStorage.getItem('fung_menu_history') || "[]");
            const select = document.getElementById('historySelect');
            if(history.length === 0) return;
            
            document.getElementById('historySection').classList.remove('hidden');
            select.innerHTML = '<option value="">-- è«‹é¸æ“‡æ­·å²é¤å»³ --</option>';
            history.forEach((h, index) => {
                select.innerHTML += `<option value="${index}">${h.name} (${new Date(h.time).toLocaleDateString()})</option>`;
            });
        }

        function loadFromHistory(index) {
            if(index === "") return;
            const history = JSON.parse(localStorage.getItem('fung_menu_history') || "[]");
            if(history[index]) {
                menuData = history[index].data;
                generateLinkAndShow(false);
            }
        }

        function clearHistory() {
            if(confirm("ç¢ºå®šè¦æ¸…é™¤æ‰€æœ‰æ­·å²èœå–®ï¼Ÿ")) {
                localStorage.removeItem('fung_menu_history');
                location.reload();
            }
        }

        function showSummary() {
            const container = document.getElementById('summary-content');
            container.innerHTML = "";
            let grandTotal = 0;
            const keys = Object.keys(allOrders);

            if (keys.length === 0) {
                container.innerHTML = "<div class='text-center text-gray-400 mt-10'><i class='fas fa-wind text-4xl mb-2'></i><br>é‚„æ²’æœ‰äººé»é¤å–”</div>";
            } else {
                keys.forEach(key => {
                    const order = allOrders[key];
                    const subtotal = order.d.reduce((sum, item) => sum + item.p, 0);
                    grandTotal += subtotal;

                    const itemsHtml = order.d.map(i => {
                        return `<div class='flex justify-between text-sm text-gray-600 pl-2 border-l-2 border-gray-200'>
                                    <span>${i.n} ${i.o ? `<span class='text-xs text-orange-500'>(${i.o})</span>` : ''}</span>
                                    <span>$${i.p}</span>
                                </div>`;
                    }).join("");

                    const div = document.createElement('div');
                    div.className = `p-3 rounded border-2 transition-all ${order.paid ? 'bg-green-50 border-green-200' : 'bg-white border-gray-200'}`;
                    div.innerHTML = `
                        <div class="flex justify-between items-center mb-2">
                            <div class="flex items-center gap-2">
                                <input type="checkbox" class="w-5 h-5 cursor-pointer accent-green-600" ${order.paid ? 'checked' : ''} onchange="togglePaid('${key}')">
                                <span class="font-bold text-lg ${order.paid ? 'text-green-700 line-through decoration-gray-400' : 'text-gray-800'}">${order.n}</span>
                            </div>
                            <span class="font-bold text-blue-600">$${subtotal}</span>
                        </div>
                        <div class="space-y-1 mb-1">${itemsHtml}</div>
                    `;
                    container.appendChild(div);
                });
            }
            document.getElementById('grand-total').textContent = "$" + grandTotal;
            document.getElementById('summary-panel').classList.remove('hidden');
        }

        function togglePaid(key) {
            if(allOrders[key]) {
                allOrders[key].paid = !allOrders[key].paid;
                showSummary();
            }
        }

        function pickRandomVictim() {
            const keys = Object.keys(allOrders);
            if(keys.length === 0) return Swal.fire('æ²’äººé»é¤', 'ç„¡æ³•æŠ½ç', 'info');
            
            let timerInterval;
            Swal.fire({
                title: 'ğŸ² å‘½é‹è½‰ç›¤...',
                html: 'èª°æ˜¯å¤©é¸ä¹‹äººï¼Ÿ <b></b>',
                timer: 2000,
                timerProgressBar: true,
                didOpen: () => {
                    Swal.showLoading();
                    const b = Swal.getHtmlContainer().querySelector('b');
                    timerInterval = setInterval(() => {
                        b.textContent = allOrders[keys[Math.floor(Math.random() * keys.length)]].n;
                    }, 100);
                },
                willClose: () => { clearInterval(timerInterval); }
            }).then(() => {
                const winner = allOrders[keys[Math.floor(Math.random() * keys.length)]];
                Swal.fire({icon: 'success', title: `ğŸ‘‰ ${winner.n}`, text: 'æ­å–œæ¦®ç²ã€Œæ‹¿å¤–è³£/æ‰“é›»è©±ã€æ®Šæ¦®ï¼'});
            });
        }

        function copyForRestaurant() {
            let itemSummary = {};
            let total = 0;
            Object.values(allOrders).forEach(order => {
                order.d.forEach(item => {
                    const key = item.n + (item.o ? ` (${item.o})` : '');
                    if (!itemSummary[key]) itemSummary[key] = { count: 0, price: item.p };
                    itemSummary[key].count++;
                    total += item.p;
                });
            });

            let text = `ğŸ“… è¨‚å–®ï¼š${menuData.r}\nâ”â”â”â”â”â”â”â”â”â”â”â”\n`;
            for (const [name, data] of Object.entries(itemSummary)) {
                text += `${name} x ${data.count}\n`;
            }
            text += `â”â”â”â”â”â”â”â”â”â”â”â”\nğŸ’° ç¸½è¨ˆï¼š$${total}\n\n(LunchCaptain V4.0)`;
            navigator.clipboard.writeText(text).then(() => Swal.fire('å·²è¤‡è£½', 'å¯è²¼çµ¦é¤å»³', 'success'));
        }

        function copyForGroup() {
            let text = `ğŸ“‹ æ”¶éŒ¢é€šçŸ¥ (${menuData.r})\nâ”â”â”â”â”â”â”â”â”â”â”â”\n`;
            let total = 0;
            let paidCount = 0;
            Object.values(allOrders).forEach(order => {
                const subtotal = order.d.reduce((s, i) => s + i.p, 0);
                total += subtotal;
                if(order.paid) paidCount++;
                text += `${order.paid ? 'âœ…' : 'â¬œ'} ${order.n}: $${subtotal}\n`;
            });
            text += `â”â”â”â”â”â”â”â”â”â”â”â”\nğŸ’° ç¸½è¨ˆ: $${total}\n(å·²ä»˜: ${paidCount} / æœªä»˜: ${Object.keys(allOrders).length - paidCount})\n\nLunchCaptain V4.0`;
            navigator.clipboard.writeText(text).then(() => Swal.fire('å·²è¤‡è£½', 'å¯è²¼åˆ°ç¾¤çµ„æ”¶éŒ¢', 'success'));
        }
    </script>
</body>
</html>
