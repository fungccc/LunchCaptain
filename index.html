<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LunchCaptain V3.4</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lz-string/1.4.4/lz-string.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <style>
        body { font-family: "Microsoft JhengHei", -apple-system, BlinkMacSystemFont, sans-serif; background-color: #f8fafc; }
        .btn { @apply font-bold py-2 px-4 rounded-lg transition duration-200 shadow-sm flex items-center justify-center; }
        .btn-primary { @apply bg-blue-600 text-white hover:bg-blue-700; }
        .btn-dark { @apply bg-gray-800 text-white hover:bg-gray-900; }
        .btn-success { @apply bg-green-600 text-white hover:bg-green-700; }
        .btn-action { @apply bg-indigo-500 text-white hover:bg-indigo-600; }
        .btn-warning { @apply bg-orange-500 text-white hover:bg-orange-600; }
        .btn-teal { @apply bg-teal-600 text-white hover:bg-teal-700; }
        .card { @apply bg-white rounded-xl shadow-lg p-5 mb-4 border border-gray-100; }
        .footer-sign { font-family: 'Courier New', monospace; letter-spacing: 1px; }
        
        /* é¸é …æ¨£å¼ */
        .option-tag { @apply border border-gray-300 rounded px-3 py-1 text-sm cursor-pointer hover:bg-blue-50 transition select-none; }
        .option-tag.active { @apply bg-blue-600 text-white border-blue-600; }
        
        /* è‡ªå®šç¾©ä¸‹æ‹‰ */
        .custom-select {
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");
            background-position: right 0.5rem center;
            background-repeat: no-repeat;
            background-size: 1.5em 1.5em;
            padding-right: 2.5rem;
            -webkit-appearance: none;
            appearance: none;
        }
    </style>
</head>
<body class="pb-32 flex flex-col min-h-screen">

    <header class="bg-slate-900 text-white p-4 shadow-lg sticky top-0 z-50 flex justify-between items-center">
        <h1 class="text-lg font-bold tracking-wider cursor-pointer flex items-center" onclick="confirmHome()">
            <i class="fas fa-utensils mr-2 text-yellow-400"></i>LunchCaptain
            <span class="ml-2 text-[10px] bg-blue-600 px-1.5 py-0.5 rounded text-white font-normal opacity-80">v3.4</span>
        </h1>
        <div id="roleBadge" class="bg-yellow-400 text-black text-xs px-2 py-1 rounded font-bold hidden shadow"></div>
    </header>

    <div class="max-w-md mx-auto p-4 flex-grow w-full relative">

        <div id="setup-panel" class="card border-t-4 border-blue-600">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold text-gray-800"><i class="fas fa-robot mr-2 text-blue-600"></i>AI èœå–®æƒæ</h2>
                <button onclick="toggleHistory()" class="text-sm text-gray-500 hover:text-blue-600 underline">æ­·å²ç´€éŒ„</button>
            </div>

            <div id="historySection" class="mb-4 hidden bg-gray-50 p-3 rounded">
                <select id="historySelect" onchange="loadFromHistory(this.value)" class="w-full p-2 border rounded text-sm mb-2">
                    <option value="">-- è¼‰å…¥èˆŠèœå–® --</option>
                </select>
                <button onclick="clearHistory()" class="text-xs text-red-400 w-full text-right">æ¸…é™¤ç´€éŒ„</button>
            </div>

            <div class="mb-4">
                <label class="text-xs text-gray-500 font-bold mb-1 block">1. æ˜¯å¦éœ€è¦ç¬¬äºŒèªè¨€ç¿»è­¯ï¼Ÿ</label>
                <select id="secondLang" class="w-full p-3 border rounded-lg text-sm custom-select bg-white focus:ring-2 focus:ring-blue-500 outline-none">
                    <option value="">ğŸš« ä¸éœ€ç¿»è­¯ (é è¨­)</option>
                    <option value="Traditional Chinese">1. ä¸­æ–‡ (ç¹é«”)</option>
                    <option value="English">2. è‹±æ–‡</option>
                    <option value="Japanese">3. æ—¥æ–‡</option>
                    <option value="Korean">4. éŸ“æ–‡</option>
                    <option value="Thai">5. æ³°æ–‡</option>
                    <option value="Vietnamese">6. è¶Šå—æ–‡</option>
                    <option value="French">7. æ³•æ–‡</option>
                    <option value="Italian">8. ç¾©å¤§åˆ©æ–‡</option>
                    <option value="Spanish">9. è¥¿ç­ç‰™æ–‡</option>
                    <option value="German">10. å¾·æ–‡</option>
                    <option value="Portuguese">11. è‘¡è„ç‰™æ–‡</option>
                    <option value="Russian">12. ä¿„æ–‡</option>
                    <option value="Arabic">13. é˜¿æ‹‰ä¼¯æ–‡</option>
                    <option value="Indonesian">14. å°å°¼æ–‡</option>
                    <option value="Tagalog">15. ä»–åŠ ç¥¿æ–‡</option>
                    <option value="Turkish">16. åœŸè€³å…¶æ–‡</option>
                    <option value="Persian">17. æ³¢æ–¯æ–‡</option>
                    <option value="Hindi">18. å°åœ°æ–‡</option>
                    <option value="Bengali">19. å­ŸåŠ æ‹‰æ–‡</option>
                    <option value="Swahili">20. æ–¯ç“¦å¸Œé‡Œæ–‡</option>
                    <option value="Czech">21. æ·å…‹æ–‡</option>
                </select>
            </div>

            <label class="text-xs text-gray-500 font-bold mb-1 block">2. é¸æ“‡ AI å¹³å°ï¼š</label>
            <div class="grid grid-cols-2 gap-2 mb-2">
                <button onclick="setAI('gemini')" id="btn-gemini" class="btn btn-primary text-xs flex-col py-3 ring-2 ring-offset-1 ring-blue-600">
                    <i class="fas fa-star mb-1"></i>Gemini
                </button>
                <button onclick="setAI('chatgpt')" id="btn-chatgpt" class="btn btn-success text-xs flex-col py-3 opacity-60 hover:opacity-100">
                    <i class="fas fa-bolt mb-1"></i>ChatGPT
                </button>
            </div>
            <div class="grid grid-cols-2 gap-2 mb-4">
                <button onclick="setAI('grok')" id="btn-grok" class="btn btn-dark text-xs flex-col py-3 opacity-60 hover:opacity-100">
                    <i class="fas fa-rocket mb-1"></i>Grok
                </button>
                <button onclick="setAI('copilot')" id="btn-copilot" class="btn btn-teal text-xs flex-col py-3 opacity-60 hover:opacity-100">
                    <i class="fab fa-microsoft mb-1"></i>Copilot
                </button>
            </div>

            <button onclick="copyPromptAndOpenAI()" class="w-full btn btn-action mb-4 shadow-md text-sm py-3">
                <i class="fas fa-copy mr-2"></i> 3. è¤‡è£½æŒ‡ä»¤ä¸¦å‰å¾€ App
            </button>

            <div class="relative group">
                <label class="text-xs text-gray-500 font-bold mb-1 block">4. è²¼ä¸Š AI å›å‚³çš„ JSONï¼š</label>
                <textarea id="jsonInput" rows="3" class="w-full p-3 border-2 border-dashed border-gray-300 rounded-lg text-xs focus:border-blue-500 focus:ring-1 focus:ring-blue-500 transition" placeholder="è²¼ä¸Šå¾Œè‡ªå‹•è§£æ..."></textarea>
                <button onclick="pasteFromClipboard()" class="absolute top-7 right-2 bg-gray-100 p-1 rounded hover:bg-gray-200 text-gray-600 text-xs shadow-sm border">
                    <i class="fas fa-paste"></i> è²¼ä¸Š
                </button>
            </div>
            
            <button onclick="parseMenuAndGenerateLink()" class="w-full btn btn-primary mt-3">
                <i class="fas fa-magic mr-2"></i> 5. è§£æä¸¦ç”Ÿæˆé»é¤ QR
            </button>
        </div>

        <div id="share-panel" class="card hidden text-center">
            <h2 class="text-lg font-bold mb-1 text-blue-800" id="shareTitle"></h2>
            <p class="text-xs text-gray-500 mb-4">è«‹åŒäº‹æƒææ­¤ QR Code é»é¤</p>
            <div id="menuQRCode" class="flex justify-center mb-4 p-2 bg-white rounded inline-block shadow-inner border"></div>
            <button onclick="enterCaptainMode()" class="btn btn-warning w-full animate-pulse">
                <i class="fas fa-user-tie mr-2"></i>æˆ‘æ˜¯åœ˜é•·ï¼Œé–‹å§‹æ”¶å–®
            </button>
        </div>

        <div id="order-panel" class="hidden">
            <div class="mb-4 sticky top-16 z-30 bg-[#f8fafc] pb-2 pt-1 shadow-sm">
                <h2 id="storeName" class="text-2xl font-bold text-gray-800 text-center mb-2"></h2>
                
                <div id="guestInfoDisplay" class="hidden text-center text-sm text-gray-600 mb-2">
                    <span id="displayRoleName" class="font-bold text-blue-600"></span> 
                    <span id="displayRolePhone" class="text-gray-400"></span>
                    <button onclick="resetGuestInfo()" class="text-xs underline ml-2 text-gray-400">ä¿®æ”¹</button>
                </div>
            </div>

            <div id="menuContainer" class="mb-20 pb-20"></div>
        </div>

        <div id="guest-fab" class="fixed bottom-6 right-6 hidden z-50">
            <span id="cartCount" class="absolute -top-2 -right-2 bg-red-500 text-white text-xs w-6 h-6 flex items-center justify-center rounded-full font-bold shadow-md transform scale-0 transition-transform duration-200">0</span>
            <button onclick="checkOut()" class="bg-green-600 text-white px-6 py-4 rounded-full shadow-2xl hover:bg-green-700 font-bold flex items-center transition transform hover:scale-105 active:scale-95">
                <i class="fas fa-check-circle mr-2"></i> é»å¥½äº†
            </button>
        </div>

        <div id="captain-fab" class="fixed bottom-6 left-6 flex flex-col gap-3 hidden z-50 items-start">
            <button onclick="startScanner()" class="bg-blue-600 text-white w-14 h-14 rounded-full shadow-2xl hover:bg-blue-700 flex items-center justify-center border-2 border-white transition transform hover:scale-110" title="æƒæåŒäº‹">
                <i class="fas fa-camera text-xl"></i>
            </button>
            <button onclick="showSummary()" class="bg-slate-800 text-white w-14 h-14 rounded-full shadow-2xl hover:bg-slate-900 flex items-center justify-center border-2 border-white transition transform hover:scale-110 relative" title="è¨‚å–®ç¸½çµ">
                <i class="fas fa-receipt text-xl"></i>
                <span id="orderCountBadge" class="absolute -top-1 -right-1 bg-red-500 text-white text-[10px] w-5 h-5 flex items-center justify-center rounded-full hidden">0</span>
            </button>
        </div>

        <div id="note-modal" class="fixed inset-0 bg-black bg-opacity-50 z-[70] hidden flex items-center justify-center px-4">
            <div class="bg-white rounded-xl w-full max-w-sm shadow-2xl overflow-hidden flex flex-col max-h-[85vh]">
                <div class="p-4 border-b bg-gray-50">
                    <h3 class="font-bold text-lg" id="note-item-name"></h3>
                    <p class="text-sm text-gray-500" id="note-item-trans"></p>
                    <p class="text-blue-600 font-bold" id="note-item-price"></p>
                </div>
                
                <div class="p-4 overflow-y-auto">
                    <p class="text-xs font-bold text-gray-500 mb-2">å®¢è£½åŒ–é¸é … (å¯å¤šé¸)</p>
                    <div class="flex flex-wrap gap-2 mb-4" id="opt-container">
                        <span class="option-tag" onclick="toggleOption(this)">å°‘è¾£</span>
                        <span class="option-tag" onclick="toggleOption(this)">ä¸­è¾£</span>
                        <span class="option-tag" onclick="toggleOption(this)">å¤§è¾£</span>
                        <span class="option-tag" onclick="toggleOption(this)">èµ°è”¥</span>
                        <span class="option-tag" onclick="toggleOption(this)">å°‘å†°</span>
                        <span class="option-tag" onclick="toggleOption(this)">å¤šå†°</span>
                        <span class="option-tag" onclick="toggleOption(this)">èµ°å†°</span>
                        <span class="option-tag" onclick="toggleOption(this)">å°‘ç”œ</span>
                        <span class="option-tag" onclick="toggleOption(this)">åŠç³–</span>
                        <span class="option-tag" onclick="toggleOption(this)">èµ°ç”œ</span>
                        <span class="option-tag" onclick="toggleOption(this)">èµ°å¥¶</span>
                        <span class="option-tag" onclick="toggleOther(this)">å…¶ä»–...</span>
                    </div>
                    <input type="text" id="note-other-input" class="w-full p-2 border rounded text-sm hidden bg-gray-50" placeholder="è«‹è¼¸å…¥å‚™è¨»å…§å®¹...">
                </div>

                <div class="p-4 border-t bg-gray-50 flex gap-2">
                    <button onclick="closeNoteModal()" class="flex-1 btn bg-gray-200 text-gray-700 hover:bg-gray-300">å–æ¶ˆ</button>
                    <button onclick="confirmAddItem()" class="flex-1 btn btn-primary">åŠ å…¥è¨‚å–®</button>
                </div>
            </div>
        </div>

        <div id="ticket-modal" class="fixed inset-0 bg-black bg-opacity-95 z-[80] hidden flex flex-col items-center justify-center p-4">
            <div class="bg-white rounded-lg p-5 w-full max-w-sm mb-4 relative shadow-2xl" id="ticket-content">
                <div class="text-center border-b-2 border-dashed border-gray-300 pb-3 mb-3">
                    <h3 class="font-bold text-xl text-gray-800" id="ticket-store"></h3>
                    <p class="text-[10px] text-gray-400 mt-1 uppercase tracking-[0.2em]">ORDER TICKET</p>
                </div>
                <div class="flex justify-between text-base mb-3 bg-gray-50 p-2 rounded border border-gray-100">
                    <span class="font-bold text-gray-700"><i class="fas fa-user mr-1 text-gray-400"></i><span id="ticket-name"></span></span>
                    <span class="font-bold text-gray-500"><i class="fas fa-phone mr-1 text-gray-400"></i><span id="ticket-phone"></span></span>
                </div>
                <div id="ticket-items" class="text-sm space-y-2 mb-4 max-h-40 overflow-y-auto"></div>
                <div class="flex justify-between font-bold text-xl border-t-2 border-gray-800 pt-3 mb-4">
                    <span>TOTAL</span>
                    <span id="ticket-total" class="text-red-600"></span>
                </div>
                <div class="flex justify-center mb-2">
                    <div id="orderQRCode"></div>
                </div>
                <p class="text-[10px] text-center text-gray-400" id="qr-hint">è«‹æˆªåœ–æˆ–è®“åœ˜é•·æƒæ</p>
            </div>
            
            <div class="grid grid-cols-2 gap-2 w-full max-w-sm mb-2">
                <button onclick="downloadTicket()" class="btn btn-success text-sm">
                    <i class="fas fa-download mr-1"></i> ä¸‹è¼‰åœ–ç‰‡
                </button>
                <button onclick="sendToWhatsapp()" class="btn btn-primary text-sm bg-green-500 hover:bg-green-600 border-none">
                    <i class="fab fa-whatsapp mr-1"></i> å‚³çµ¦åœ˜é•·
                </button>
            </div>
            
            <button onclick="document.getElementById('ticket-modal').classList.add('hidden')" class="text-white underline text-sm mt-4 bg-gray-800 px-4 py-2 rounded-full">
                <i class="fas fa-edit mr-1"></i> ä¿®æ”¹è¨‚å–® (è¿”å›)
            </button>
        </div>

        <div id="scanner-modal" class="fixed inset-0 bg-black z-[80] hidden flex flex-col">
            <div class="flex justify-between items-center p-4 bg-black text-white">
                <h3 class="font-bold text-lg"><i class="fas fa-camera mr-2"></i>æƒæè¨‚å–®</h3>
                <button onclick="stopScanner()" class="text-2xl opacity-80 hover:opacity-100"><i class="fas fa-times"></i></button>
            </div>
            <div class="flex-grow flex flex-col justify-center bg-black relative">
                <div id="reader" class="w-full h-64 bg-gray-900 border-y-2 border-blue-500"></div>
                <div class="absolute bottom-0 w-full bg-gray-900 p-6 rounded-t-3xl border-t border-gray-700">
                    <p class="text-xs text-gray-400 mb-2 text-center">æˆ–è²¼ä¸Šè¨‚å–®ä»£ç¢¼ï¼š</p>
                    <div class="flex gap-2">
                        <input type="text" id="manualOrderInput" class="flex-1 bg-gray-800 text-white border border-gray-700 rounded-lg p-3 text-sm focus:border-blue-500 focus:outline-none" placeholder="åœ¨æ­¤è²¼ä¸Šä»£ç¢¼...">
                        <button onclick="manualImportOrder()" class="btn btn-action whitespace-nowrap"><i class="fas fa-file-import"></i></button>
                    </div>
                </div>
            </div>
        </div>

        <div id="summary-panel" class="fixed inset-0 bg-gray-100 z-[70] hidden flex flex-col">
            <div class="bg-white p-4 shadow-md flex justify-between items-center sticky top-0 z-10">
                <h2 class="text-xl font-bold text-gray-800"><i class="fas fa-clipboard-list mr-2 text-blue-600"></i>è¨‚å–®ç¸½çµ</h2>
                <button onclick="document.getElementById('summary-panel').classList.add('hidden')" class="text-gray-400 hover:text-gray-600"><i class="fas fa-times text-xl"></i></button>
            </div>
            <div id="summary-content" class="flex-grow overflow-y-auto p-4 space-y-3 pb-40"></div>
            <div class="bg-white p-4 shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.1)] sticky bottom-0 z-10">
                <div class="flex justify-between text-xl font-bold mb-3 border-b pb-2">
                    <span>ç¸½é‡‘é¡</span>
                    <span id="grand-total" class="text-red-600">$0</span>
                </div>
                <div class="grid grid-cols-2 gap-2 mb-2">
                    <button onclick="copyForRestaurant()" class="btn btn-primary text-xs bg-green-600 hover:bg-green-700">
                        <i class="fab fa-whatsapp mr-1"></i> (WhatsApp)
                    </button>
                    <button onclick="shareSystem()" class="btn btn-dark text-xs">
                        <i class="fas fa-share-alt mr-1"></i> ç³»çµ±åˆ†äº«
                    </button>
                </div>
                <button onclick="copyForGroup()" class="w-full btn btn-action text-xs mb-2">
                     <i class="fas fa-users mr-1"></i> è¤‡è£½æ¸…å–® (Line)
                </button>
            </div>
        </div>

    </div>

    <footer class="text-center text-gray-400 text-xs py-6 mt-auto footer-sign border-t bg-white">
        <p class="font-bold text-gray-500">LunchCaptain â€¢ åœ˜é•·æ•‘æ˜Ÿ</p>
        <p class="opacity-50 text-[10px]">V3.4 AI Powered</p>
    </footer>

    <script>
        // --- æ ¸å¿ƒç‹€æ…‹ ---
        let currentAI = 'gemini';
        let menuData = null;
        let myCart = []; 
        let allOrders = {}; 
        let html5QrcodeScanner = null;
        let tempItem = null; 
        let userInfo = { name: '', phone: '' };
        let isCaptainMode = false;
        
        // ğŸ›¡ï¸ é˜²æ­¢æ‰‹æ»‘é›¢é–‹é é¢
        window.addEventListener('beforeunload', function (e) {
            // åªæœ‰ç•¶è³¼ç‰©è»Šæœ‰æ±è¥¿ï¼Œä¸”é‚„æ²’é€å‡º(è³¼ç‰©è»Šæœªæ¸…ç©º)æ™‚æ‰è­¦å‘Š
            if (myCart.length > 0) {
                e.preventDefault();
                e.returnValue = '';
            }
        });

        // é»æ“Šæ¨™é¡Œå›é¦–é çš„ä¿è­·
        function confirmHome() {
            if(myCart.length > 0) {
                if(confirm("æ‚¨æœ‰é»é¤å°šæœªå„²å­˜ï¼Œç¢ºå®šè¦å›åˆ°é¦–é å—ï¼Ÿ")) {
                    location.href = location.pathname.split('#')[0];
                }
            } else {
                location.href = location.pathname.split('#')[0];
            }
        }
        
        // --- 1. åˆå§‹åŒ– ---
        window.onload = function() {
            if(window.location.hash === "#import_menu") {
                document.getElementById('setup-panel').scrollIntoView();
                document.getElementById('jsonInput').focus();
                history.replaceState(null, null, ' ');
                Swal.fire({icon: 'info', title: 'æ­¡è¿å›ä¾†', text: 'è«‹è²¼ä¸Š JSON', timer: 2000, showConfirmButton: false});
            }

            const params = new URLSearchParams(window.location.search);
            const compressedMenu = params.get('menu');

            if (compressedMenu) {
                initGuestMode(compressedMenu);
            } else {
                initCaptainMode();
            }
        };

        function initCaptainMode() {
            document.getElementById('setup-panel').classList.remove('hidden');
            loadHistoryDropdown();
            setAI('gemini');
        }

        function toggleHistory() {
            document.getElementById('historySection').classList.toggle('hidden');
        }

        // --- 2. AI æŒ‡ä»¤å€ ---
        function setAI(ai) {
            currentAI = ai;
            ['gemini','chatgpt','grok','copilot'].forEach(k => {
                const btn = document.getElementById(`btn-${k}`);
                if(btn) {
                    btn.classList.remove('ring-2', 'ring-offset-1', 'ring-blue-600', 'opacity-100');
                    btn.classList.add('opacity-60');
                }
            });
            const activeBtn = document.getElementById(`btn-${currentAI}`);
            if(activeBtn) {
                activeBtn.classList.remove('opacity-60');
                activeBtn.classList.add('ring-2', 'ring-offset-1', 'ring-blue-600', 'opacity-100');
            }
        }

        function copyPromptAndOpenAI() {
            const returnUrl = window.location.href.split('#')[0].split('?')[0] + "#import_menu";
            const targetLang = document.getElementById('secondLang').value;
            
            let transInstruction = `field "n" MUST be the ORIGINAL language shown in the image (DO NOT Translate "n").`;
            let outputFields = `"n":"Original Name", "p":Price_Number`;
            
            if (targetLang) {
                transInstruction += ` Also, add a new field "t" which is the translation of "n" into ${targetLang}.`;
                outputFields += `, "t":"Translated Name in ${targetLang}"`;
            }

            let promptText = `Role: Professional Menu Data Analyst.
Task: Analyze the uploaded menu image.
Output Format: Strict JSON ONLY. No markdown code blocks.
JSON Structure: {"r":"Restaurant Name","m":[{"c":"Category Name","i":[{${outputFields}}]}]}
Rules:
1. ${transInstruction}
2. "p" (Price) must be a number.
3. If size options exist, create separate items.
4. AFTER the JSON, append a new line with this exact Markdown link: [â†©ï¸ Click here to Import Menu](${returnUrl})`;

            if(currentAI === 'grok') promptText += `\n\n(Note: If using Grok App, please manually switch back to browser to paste)`;

            navigator.clipboard.writeText(promptText).then(() => {
                let url = "https://gemini.google.com/";
                if(currentAI === 'chatgpt') url = "https://chat.openai.com/";
                if(currentAI === 'grok') url = "https://x.com/i/grok";
                if(currentAI === 'copilot') url = "https://copilot.microsoft.com/";

                Swal.fire({
                    icon: 'success', title: 'æŒ‡ä»¤å·²è¤‡è£½', 
                    text: targetLang ? `å·²è¨­å®šç¿»è­¯ç‚ºï¼š${targetLang}` : 'å·²è¨­å®šä¿ç•™åŸæ–‡',
                    timer: 1500, showConfirmButton: false
                }).then(() => window.open(url, '_blank'));
            });
        }

        async function pasteFromClipboard() {
            try {
                const text = await navigator.clipboard.readText();
                document.getElementById('jsonInput').value = text;
            } catch (err) {
                Swal.fire('æ¬Šé™æç¤º', 'ç€è¦½å™¨é˜»æ“‹è‡ªå‹•è²¼ä¸Šï¼Œè«‹æ‰‹å‹•é»æ“Šè¼¸å…¥æ¡†è²¼ä¸Š', 'info');
            }
        }

        function parseMenuAndGenerateLink() {
            const raw = document.getElementById('jsonInput').value;
            if(!raw) return Swal.fire('éŒ¯èª¤', 'è«‹å…ˆè²¼ä¸Š JSON', 'error');

            try {
                const jsonMatch = raw.match(/\{[\s\S]*\}/);
                if (!jsonMatch) throw new Error("æ‰¾ä¸åˆ° JSON å€å¡Š");
                const cleanJson = jsonMatch[0];
                menuData = JSON.parse(cleanJson);
                if (!menuData.m) throw new Error("JSON ç¼ºå°‘ menu");
                
                saveToHistory(menuData);
                generateLinkAndShow();
            } catch (e) {
                Swal.fire({icon: 'error', title: 'è§£æå¤±æ•—', text: e.message});
            }
        }

        // --- æ­·å²ç´€éŒ„ ---
        function saveToHistory(data) {
            let history = JSON.parse(localStorage.getItem('lunch_captain_history') || "[]");
            history = history.filter(h => h.name !== data.r);
            history.unshift({ name: data.r, data: data, time: Date.now() });
            if(history.length > 5) history.pop();
            localStorage.setItem('lunch_captain_history', JSON.stringify(history));
            loadHistoryDropdown();
        }

        function loadHistoryDropdown() {
            const history = JSON.parse(localStorage.getItem('lunch_captain_history') || "[]");
            const select = document.getElementById('historySelect');
            if(history.length > 0) {
                document.getElementById('historySection').classList.remove('hidden');
                select.innerHTML = '<option value="">-- è¼‰å…¥èˆŠèœå–® --</option>';
                history.forEach((h, index) => {
                    select.innerHTML += `<option value="${index}">${h.name} (${new Date(h.time).toLocaleDateString()})</option>`;
                });
            }
        }

        function loadFromHistory(index) {
            if(index === "") return;
            const history = JSON.parse(localStorage.getItem('lunch_captain_history') || "[]");
            menuData = history[index].data;
            generateLinkAndShow();
        }

        function clearHistory() {
            if(confirm('ç¢ºå®šæ¸…é™¤ç´€éŒ„ï¼Ÿ')) {
                localStorage.removeItem('lunch_captain_history');
                location.reload();
            }
        }

        function generateLinkAndShow() {
            const jsonString = JSON.stringify(menuData);
            const compressed = LZString.compressToEncodedURIComponent(jsonString);
            const shareUrl = `${window.location.origin}${window.location.pathname}?menu=${compressed}`;
            
            document.getElementById('shareTitle').textContent = menuData.r;
            const qrContainer = document.getElementById('menuQRCode');
            qrContainer.innerHTML = "";
            new QRCode(qrContainer, { text: shareUrl, width: 220, height: 220, correctLevel: QRCode.CorrectLevel.L });

            document.getElementById('setup-panel').classList.add('hidden');
            document.getElementById('share-panel').classList.remove('hidden');
        }

        function enterCaptainMode() {
            isCaptainMode = true; 
            document.getElementById('roleBadge').textContent = "åœ˜é•·æ¨¡å¼";
            document.getElementById('roleBadge').classList.remove('hidden');
            document.getElementById('share-panel').classList.add('hidden');
            document.getElementById('order-panel').classList.remove('hidden');
            document.getElementById('captain-fab').classList.remove('hidden');
            document.getElementById('guest-fab').classList.remove('hidden'); 
            
            userInfo.name = "åœ˜é•·";
            userInfo.phone = "000";
            updateUserDisplay();
            
            renderMenu();
        }

        // --- 3. é»é¤é‚è¼¯ ---
        function initGuestMode(compressed) {
            try {
                const jsonString = LZString.decompressFromEncodedURIComponent(compressed);
                menuData = JSON.parse(jsonString);
                document.getElementById('roleBadge').textContent = "é»é¤æ¨¡å¼";
                document.getElementById('roleBadge').classList.remove('hidden');
                document.getElementById('setup-panel').classList.add('hidden');
                document.getElementById('order-panel').classList.remove('hidden');
                document.getElementById('guest-fab').classList.remove('hidden');
                
                const savedUser = localStorage.getItem('lunch_captain_user');
                if(savedUser) {
                    userInfo = JSON.parse(savedUser);
                    updateUserDisplay();
                }

                renderMenu();
            } catch (e) {
                Swal.fire('éŒ¯èª¤', 'ç„¡æ•ˆé€£çµ', 'error').then(() => location.href = location.pathname.split('?')[0]);
            }
        }

        function renderMenu() {
            document.getElementById('storeName').textContent = menuData.r || "é¤å»³";
            const container = document.getElementById('menuContainer');
            container.innerHTML = "";

            menuData.m.forEach(cat => {
                const section = document.createElement('div');
                section.className = "mb-4";
                section.innerHTML = `<h3 class="font-bold text-gray-700 border-l-4 border-blue-500 pl-2 mb-2 sticky top-[8.5rem] bg-[#f8fafc] z-20 py-1 shadow-sm">${cat.c}</h3>`;
                const grid = document.createElement('div');
                grid.className = "grid grid-cols-1 gap-2";
                cat.i.forEach(item => {
                    const el = document.createElement('div');
                    el.className = "bg-white p-4 rounded-lg shadow-sm flex justify-between items-center cursor-pointer hover:bg-blue-50 transition border border-gray-100 active:scale-[0.98]";
                    el.onclick = () => openNoteModal(item);
                    
                    const subName = item.t ? `<div class="text-xs text-gray-500 mt-1">${item.t}</div>` : '';
                    
                    el.innerHTML = `
                        <div>
                            <div class="text-gray-800 font-medium">${item.n}</div>
                            ${subName}
                        </div>
                        <span class="font-bold text-blue-600">$${item.p}</span>
                    `;
                    grid.appendChild(el);
                });
                section.appendChild(grid);
                container.appendChild(section);
            });
        }

        // --- Modal é‚è¼¯ ---
        function openNoteModal(item) {
            tempItem = item;
            document.getElementById('note-item-name').textContent = item.n;
            document.getElementById('note-item-trans').textContent = item.t || '';
            document.getElementById('note-item-price').textContent = `$${item.p}`;
            
            document.querySelectorAll('.option-tag').forEach(el => el.classList.remove('active'));
            document.getElementById('note-other-input').value = "";
            document.getElementById('note-other-input').classList.add('hidden');
            document.getElementById('note-modal').classList.remove('hidden');
        }

        function closeNoteModal() {
            document.getElementById('note-modal').classList.add('hidden');
            tempItem = null;
        }

        function toggleOption(el, allowMultiple = true) {
            el.classList.toggle('active');
        }

        function toggleOther(el) {
            el.classList.toggle('active');
            const input = document.getElementById('note-other-input');
            if(el.classList.contains('active')) {
                input.classList.remove('hidden');
                input.focus();
            } else {
                input.classList.add('hidden');
            }
        }

        function confirmAddItem() {
            if (!tempItem) return;
            let notes = [];
            document.querySelectorAll('.option-tag.active').forEach(tag => {
                if(!tag.textContent.includes('å…¶ä»–')) notes.push(tag.textContent);
            });
            const otherText = document.getElementById('note-other-input').value.trim();
            if(otherText) notes.push(otherText);

            const noteString = notes.join(', ');
            myCart.push({ n: tempItem.n, p: tempItem.p, o: noteString }); 
            
            updateCartBadge();
            closeNoteModal();
            const Toast = Swal.mixin({toast: true, position: 'top', showConfirmButton: false, timer: 1000});
            Toast.fire({icon: 'success', title: 'å·²åŠ å…¥'});
        }

        function updateCartBadge() {
            const badge = document.getElementById('cartCount');
            badge.innerText = myCart.length;
            badge.classList.remove('scale-0');
            badge.classList.add('scale-100');
        }

        // --- 4. çµç®— (ä¿®å¾©ç‰ˆ) ---
        
        async function checkOut() {
            if (myCart.length === 0) return Swal.fire('è³¼ç‰©è»Šç©ºçš„', 'è«‹å…ˆé»é¤', 'warning');

            // æª¢æŸ¥å€‹äººè³‡æ–™
            if (!userInfo.name || !userInfo.phone) {
                // å¼·åˆ¶å½ˆå‡ºè¼¸å…¥æ¡†
                const { value: formValues } = await Swal.fire({
                    title: 'è«‹è¼¸å…¥è¨‚è³¼äººè³‡æ–™',
                    html:
                        '<input id="swal-input1" class="swal2-input" placeholder="ä½ çš„åå­—" value="' + (userInfo.name || '') + '">' +
                        '<input id="swal-input2" class="swal2-input" type="tel" placeholder="é›»è©±å¾Œ3ç¢¼" value="' + (userInfo.phone || '') + '">',
                    focusConfirm: false,
                    allowOutsideClick: false, // ç¦æ­¢é»å¤–é¢é—œé–‰
                    preConfirm: () => {
                        const n = document.getElementById('swal-input1').value;
                        const p = document.getElementById('swal-input2').value;
                        if (!n || !p) {
                            Swal.showValidationMessage('è«‹å¡«å¯«å®Œæ•´è³‡æ–™');
                            return false;
                        }
                        return [n, p];
                    }
                });

                if (formValues) {
                    userInfo.name = formValues[0];
                    userInfo.phone = formValues[1];
                    localStorage.setItem('lunch_captain_user', JSON.stringify(userInfo));
                    updateUserDisplay();
                    processOrder();
                }
            } else {
                processOrder();
            }
        }

        function processOrder() {
            // å¦‚æœæ˜¯åœ˜é•·ï¼Œç›´æ¥åŠ å…¥ï¼›å¦‚æœæ˜¯åŒäº‹ï¼Œé¡¯ç¤º QR
            if (isCaptainMode) {
                Swal.fire({
                    title: 'åœ˜é•·è¨‚å–®ç¢ºèª',
                    text: `ç¢ºèªå°‡ ${myCart.length} æ¨£é¤é»åŠ å…¥ç¸½è¡¨å—ï¼Ÿ`,
                    icon: 'question',
                    showCancelButton: true,
                    confirmButtonText: 'åŠ å…¥ç¸½è¡¨'
                }).then((result) => {
                    if (result.isConfirmed) {
                        const orderData = { n: userInfo.name, t: userInfo.phone, d: [...myCart] };
                        const key = `${orderData.n}-${orderData.t}`;
                        addOrderToSystem(key, orderData); 
                        myCart = []; // æ¸…ç©ºè³¼ç‰©è»Š
                        updateCartBadge();
                        Swal.fire('æˆåŠŸ', 'åœ˜é•·è¨‚å–®å·²åŠ å…¥ç¸½çµ', 'success');
                    }
                });
            } else {
                // åŒäº‹æ¨¡å¼ï¼šå¼·åˆ¶é¡¯ç¤º QR Modal
                generateOrderTicket(); 
            }
        }

        function updateUserDisplay() {
            document.getElementById('displayRoleName').textContent = userInfo.name;
            document.getElementById('displayRolePhone').textContent = userInfo.phone;
            document.getElementById('guestInfoDisplay').classList.remove('hidden');
        }

        function resetGuestInfo() {
            userInfo = { name: '', phone: '' };
            localStorage.removeItem('lunch_captain_user');
            document.getElementById('guestInfoDisplay').classList.add('hidden');
            // è®“ä½¿ç”¨è€…çŸ¥é“å·²æ¸…é™¤ï¼Œä¸‹æ¬¡é»é¤æœƒå†å•
            Swal.fire('å·²é‡ç½®', 'ä¸‹æ¬¡é»é¤æ™‚è«‹é‡æ–°è¼¸å…¥è³‡æ–™', 'info');
        }

        function generateOrderTicket() {
            let total = 0;
            const itemsHtml = myCart.map(i => {
                total += i.p;
                const noteHtml = i.o ? `<span class="text-xs text-orange-500 block ml-2">â”” ${i.o}</span>` : '';
                return `<div class="border-b border-gray-100 pb-1 mb-1"><div class="flex justify-between"><span>${i.n}</span><span>$${i.p}</span></div>${noteHtml}</div>`;
            }).join("");

            const orderData = { n: userInfo.name, t: userInfo.phone, d: myCart };
            const orderString = JSON.stringify(orderData);

            document.getElementById('ticket-store').textContent = menuData.r;
            document.getElementById('ticket-name').textContent = userInfo.name;
            document.getElementById('ticket-phone').textContent = userInfo.phone;
            document.getElementById('ticket-items').innerHTML = itemsHtml;
            document.getElementById('ticket-total').textContent = "$" + total;

            const qrContainer = document.getElementById('orderQRCode');
            qrContainer.innerHTML = "";
            new QRCode(qrContainer, { text: orderString, width: 180, height: 180 });

            document.getElementById('ticket-modal').dataset.orderString = orderString;
            document.getElementById('ticket-modal').classList.remove('hidden');
        }

        function downloadTicket() {
            html2canvas(document.getElementById('ticket-content')).then(canvas => {
                const link = document.createElement('a');
                link.download = `é»é¤å¡_${userInfo.name}.png`;
                link.href = canvas.toDataURL();
                link.click();
            });
        }

        function sendToWhatsapp() {
            const str = document.getElementById('ticket-modal').dataset.orderString;
            const url = `whatsapp://send?text=${encodeURIComponent(str)}`;
            window.location.href = url;
        }

        // --- 5. åœ˜é•·æ”¶å–® ---
        function startScanner() {
            document.getElementById('scanner-modal').classList.remove('hidden');
            html5QrcodeScanner = new Html5Qrcode("reader");
            html5QrcodeScanner.start({ facingMode: "environment" }, { fps: 10, qrbox: 250 }, onScanSuccess);
        }

        function stopScanner() {
            if (html5QrcodeScanner) {
                html5QrcodeScanner.stop().then(() => {
                    document.getElementById('scanner-modal').classList.add('hidden');
                    html5QrcodeScanner = null;
                });
            } else {
                document.getElementById('scanner-modal').classList.add('hidden');
            }
        }

        function manualImportOrder() {
            const val = document.getElementById('manualOrderInput').value.trim();
            if(val) onScanSuccess(val, null);
            document.getElementById('manualOrderInput').value = "";
        }

        function onScanSuccess(decodedText, result) {
            try {
                const order = JSON.parse(decodedText);
                if (!order.n || !order.d) throw new Error("æ ¼å¼éŒ¯èª¤");

                if(html5QrcodeScanner) html5QrcodeScanner.pause();
                const key = `${order.n}-${order.t}`;
                
                if(allOrders[key]) {
                    Swal.fire({
                        title: 'é‡è¤‡è¨‚å–®', text: `${order.n} å·²å­˜åœ¨ï¼Œè¦è¦†è“‹å—ï¼Ÿ`, icon: 'question',
                        showCancelButton: true, confirmButtonText: 'è¦†è“‹', cancelButtonText: 'å–æ¶ˆ'
                    }).then((res) => {
                        if(res.isConfirmed) addOrderToSystem(key, order);
                        if(html5QrcodeScanner) html5QrcodeScanner.resume();
                    });
                } else {
                    addOrderToSystem(key, order);
                    Swal.fire({icon: 'success', title: `${order.n} åŠ å…¥æˆåŠŸ`, timer: 1000, showConfirmButton: false});
                    if(html5QrcodeScanner) html5QrcodeScanner.resume();
                }
            } catch (e) {
                if(!html5QrcodeScanner) Swal.fire("ç„¡æ•ˆä»£ç¢¼", "è«‹ç¢ºèªæ ¼å¼æ­£ç¢º", "error");
            }
        }

        function addOrderToSystem(key, order) {
            order.paid = false;
            allOrders[key] = order;
            updateOrderBadge();
            if(!document.getElementById('summary-panel').classList.contains('hidden')) {
                showSummary();
            }
        }

        function updateOrderBadge() {
            const count = Object.keys(allOrders).length;
            const badge = document.getElementById('orderCountBadge');
            badge.textContent = count;
            badge.classList.toggle('hidden', count === 0);
        }

        // --- 6. çµç®—è¼¸å‡º ---
        function showSummary() {
            const container = document.getElementById('summary-content');
            container.innerHTML = "";
            let grandTotal = 0;
            const keys = Object.keys(allOrders);

            // æ‰‹å‹•åŠ å…¥æŒ‰éˆ•
            const addManualBtn = document.createElement('button');
            addManualBtn.className = "w-full border-2 border-dashed border-gray-300 text-gray-500 p-2 rounded mb-4 text-sm hover:border-blue-500 hover:text-blue-600";
            addManualBtn.innerHTML = "<i class='fas fa-plus mr-1'></i> æ‰‹å‹•è¼¸å…¥ä»£ç¢¼";
            addManualBtn.onclick = () => {
                document.getElementById('summary-panel').classList.add('hidden');
                startScanner();
            };
            container.appendChild(addManualBtn);

            if (keys.length === 0) {
                container.innerHTML += "<div class='text-center text-gray-400 mt-4'><i class='fas fa-clipboard text-4xl mb-2'></i><br>å°šç„¡è¨‚å–®</div>";
            } else {
                keys.forEach(key => {
                    const order = allOrders[key];
                    const subtotal = order.d.reduce((sum, item) => sum + item.p, 0);
                    grandTotal += subtotal;

                    const itemsHtml = order.d.map(i => 
                        `<div class='flex justify-between text-sm text-gray-600 pl-2 border-l-2 border-gray-200'>
                            <span>${i.n} ${i.o ? `<span class='text-xs text-orange-500'>(${i.o})</span>` : ''}</span>
                            <span>$${i.p}</span>
                        </div>`
                    ).join("");

                    const div = document.createElement('div');
                    div.className = `p-3 rounded border-2 transition-all ${order.paid ? 'bg-green-50 border-green-200' : 'bg-white border-gray-200'}`;
                    div.innerHTML = `
                        <div class="flex justify-between items-center mb-2">
                            <div class="flex items-center gap-2">
                                <input type="checkbox" class="w-5 h-5 accent-green-600 cursor-pointer" ${order.paid ? 'checked' : ''} onchange="togglePaid('${key}')">
                                <span class="font-bold ${order.paid ? 'text-green-700 line-through decoration-gray-400' : 'text-gray-800'}">${order.n}</span>
                            </div>
                            <span class="font-bold text-blue-600">$${subtotal}</span>
                        </div>
                        <div class="space-y-1 mb-1">${itemsHtml}</div>
                    `;
                    container.appendChild(div);
                });
            }
            document.getElementById('grand-total').textContent = "$" + grandTotal;
            document.getElementById('summary-panel').classList.remove('hidden');
        }

        function togglePaid(key) {
            if(allOrders[key]) {
                allOrders[key].paid = !allOrders[key].paid;
                showSummary();
            }
        }

        function copyForRestaurant() {
            let itemSummary = {};
            let total = 0;
            Object.values(allOrders).forEach(order => {
                order.d.forEach(item => {
                    const k = item.n + (item.o ? ` (${item.o})` : '');
                    if (!itemSummary[k]) itemSummary[k] = { count: 0, price: item.p };
                    itemSummary[k].count++;
                    total += item.p;
                });
            });

            let text = `ğŸ“… è¨‚å–®ï¼š${menuData.r}\nâ”â”â”â”â”â”â”â”â”â”â”â”\n`;
            for (const [n, d] of Object.entries(itemSummary)) {
                text += `${n} x ${d.count}\n`;
            }
            text += `â”â”â”â”â”â”â”â”â”â”â”â”\nğŸ’° ç¸½è¨ˆï¼š$${total}\n(LunchCaptain)`;
            window.location.href = `whatsapp://send?text=${encodeURIComponent(text)}`;
        }

        function copyForGroup() {
            let text = `ğŸ“‹ æ”¶éŒ¢é€šçŸ¥ (${menuData.r})\nâ”â”â”â”â”â”â”â”â”â”â”â”\n`;
            let total = 0;
            let paidCount = 0;
            Object.values(allOrders).forEach(order => {
                total += order.d.reduce((s, i) => s + i.p, 0);
                if(order.paid) paidCount++;
                text += `${order.paid ? 'âœ…' : 'â¬œ'} ${order.n}: $${order.d.reduce((s,i)=>s+i.p,0)}\n`;
            });
            text += `â”â”â”â”â”â”â”â”â”â”â”â”\nğŸ’° ç¸½è¨ˆ: $${total}\n(å·²ä»˜: ${paidCount} / æœªä»˜: ${Object.keys(allOrders).length - paidCount})`;
            navigator.clipboard.writeText(text).then(() => Swal.fire('å·²è¤‡è£½', 'å¯è²¼åˆ°ç¾¤çµ„', 'success'));
        }

        async function shareSystem() {
            if (navigator.share) {
                try {
                    await navigator.share({
                        title: 'LunchCaptain é»é¤',
                        text: `å¿«ä¾†é»é¤ï¼é¤å»³ï¼š${menuData.r}`,
                        url: window.location.href
                    });
                } catch (err) {
                    console.log('Share canceled');
                }
            } else {
                Swal.fire('ä¸æ”¯æ´', 'æ­¤ç€è¦½å™¨ä¸æ”¯æ´ç³»çµ±åˆ†äº«', 'info');
            }
        }
    </script>
</body>
</html>
